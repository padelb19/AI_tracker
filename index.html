<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI‑tracker</title>

  <!-- Chart.js (all charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* ------------ GLOBAL / EXISTING STYLES ------------- */
    body{margin:0;padding:0;font-family:Arial, sans-serif;background:#fff}
    header{width:100%;background:#f2f2f2;padding:10px}
    .header-top{display:flex;align-items:center}
    .left-block,.center-block,.right-block{flex:1;min-height:50px}
    .left-block{display:flex;align-items:center;justify-content:flex-start}
    .logo{height:80px;margin-left:10px}
    .center-block{display:flex;align-items:center;justify-content:center;text-align:center}
    .center-block h1{margin:0;font-size:1.8em}
    nav{display:flex;justify-content:center;gap:20px;margin-top:10px}
    nav button{padding:10px 20px;cursor:pointer;background:#fff;border:1px solid #ccc;border-radius:4px}
    nav button:hover{background:#eee}
    .page{display:none;padding:20px}.active{display:block}

    /* accueil & cards */
    #accueil h2{text-align:center;margin-top:30px}
    .explanation{max-width:800px;margin:30px auto;text-align:center;line-height:1.4em}
    .additional-figures{max-width:1000px;margin:40px auto}
    .figures-row{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin-bottom:40px}
    .key-figure-card{border:1px solid #ccc;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,.1);padding:20px;width:200px;text-align:center;background:#fff}

    /* dashboards */
    #dashboards{margin:0 auto;max-width:1000px}
    #dashboards h2{text-align:center;margin-bottom:10px}
    .sub-nav{text-align:center;margin-bottom:20px}
    .sub-nav button{margin:5px;background:#fff;border:1px solid #ccc;cursor:pointer;border-radius:4px}
    .chart-section{margin-bottom:40px}
    .chart-container{max-width:800px;width:100%;margin:0 auto}

    /* smaller pie‑chart container */
    #sizeSection .chart-container{max-width:400px;height:400px;margin:0 auto}

    /* toggle‑button “cursor” style */
    .toggle-btn{position:relative;display:inline-block;width:90px;height:30px;border:none;border-radius:15px;background:#ccc;color:#fff;font-size:12px;font-weight:bold;cursor:pointer;transition:background .3s, color .3s}
    .toggle-btn .slider{position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;transition:left .3s}
    .toggle-btn.active{background:#4caf50;color:#fff}
    .toggle-btn.active .slider{left:63px}
    .toggle-label{margin-left:8px;font-size:14px;font-weight:bold}
    .chart-controls{display:flex;justify-content:center;align-items:center;gap:15px;margin:10px 0}
    #mapOffersSection .map-container{width:600px;height:600px;margin:0 auto}

    /* projects */
    #projects h2{text-align:center;margin-bottom:40px}
    #projects section{max-width:800px;margin:0 auto 30px}
    #projects section h3{border-bottom:1px solid #ccc;padding-bottom:5px;margin-bottom:10px}
  </style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="left-block"><img src="logo.png" alt="AI‑tracker logo" class="logo"/></div>
    <div class="center-block"><h1>AI‑tracker</h1></div>
    <div class="right-block"></div>
  </div>
  <nav>
    <button onclick="showPage('accueil')">Accueil</button>
    <button onclick="showPage('dashboards')">Dashboards</button>
    <button onclick="showPage('projects')">About</button>
  </nav>
</header>

<!-- -------------------- ACCUEIL -------------------- -->
<div id="accueil" class="page active">
  <h2>Welcome to the AI‑tracker!</h2>
  <p style="text-align:center;">Here you can find insights into the evolution of AI adoption by French firms, based on their recruitment data.</p>
  <div class="explanation">
    This tracker is built using machine‑learning models on the JOCAS database (DARES). By automatically detecting AI‑related job offers, it tracks the diffusion of AI in the French economy.
  </div>

  <div class="additional-figures">
    <div class="figures-row">
      <div class="key-figure-card"><h4>Total AI Offers</h4><p id="aiOffersValue">...</p><p><small id="aiOffersLastQuarter">...</small></p></div>
      <div class="key-figure-card"><h4>Firms Having Adopted AI</h4><p id="aiFirmsValue">...</p><p><small id="aiFirmsLastQuarter">...</small></p></div>
    </div>
    <div class="figures-row">
      <div class="key-figure-card"><h4>Total GenAI Offers</h4><p id="genAiOffersValue">...</p><p><small id="genAiOffersLastQuarter">...</small></p></div>
      <div class="key-figure-card"><h4>Firms Having Adopted GenAI</h4><p id="genAiFirmsValue">...</p><p><small id="genAiFirmsLastQuarter">...</small></p></div>
    </div>
  </div>
</div>

<!-- -------------------- DASHBOARDS -------------------- -->
<div id="dashboards" class="page">
  <h2>Dashboards</h2>

  <div class="sub-nav">
    <button onclick="scrollToSection('totalOffersSection')">Total Offers</button>
    <button onclick="scrollToSection('sectorsSection')">Sectors</button>
    <button onclick="scrollToSection('sizeSection')">Firm‑size</button>
    <button onclick="scrollToSection('mapOffersSection')">Map</button>
  </div>

  <!-- 1) offers -->
  <div id="totalOffersSection" class="chart-section">
    <h3>Evolution of AI‑Related Job Offers</h3>
    <div class="chart-controls">
      <button id="btnOfferMode" class="toggle-btn" onclick="toggleTotalShare()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblOfferMode">Total</span>
    </div>
    <div class="chart-container"><canvas id="offersChart"></canvas></div>
  </div>

  <!-- 2) sectors -->
  <div id="sectorsSection" class="chart-section">
    <h3>Firms Adopting AI by Sector</h3>
    <div class="chart-controls">
      <button id="btnSectorMode" class="toggle-btn" onclick="toggleSectorsTotalShare()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSectorMode">Total</span>

      <button id="btnSectorCat" class="toggle-btn" onclick="toggleSectorsGenNonGen()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSectorCat">Gen AI</span>
    </div>
    <div class="chart-container"><canvas id="sectorsChart"></canvas></div>
  </div>

  <!-- 2.5) firm‑size pie -->
  <div id="sizeSection" class="chart-section">
    <h3>Distribution of AI Adopters by Firm Size</h3>
    <div class="chart-controls">
      <button id="btnSizeCat" class="toggle-btn" onclick="toggleSizeAiGen()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSizeCat">AI</span>
    </div>
    <div class="chart-container"><canvas id="sizeChart"></canvas></div>
  </div>

  <!-- 3) map -->
  <div id="mapOffersSection" class="chart-section">
    <h3>Map of French Zones d’Emplois</h3>
    <div class="chart-controls">
      <button id="btnMapMode" class="toggle-btn" onclick="toggleMapTotalShare()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblMapMode">Total</span>

      <button id="btnMapCat" class="toggle-btn" onclick="toggleMapAiGen()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblMapCat">AI</span>
    </div>
    <div class="map-container" id="mapOffers"></div>
  </div>
</div>

<!-- -------------------- PROJECTS (unchanged) -------------------- -->
<div id="projects" class="page">
  <h2>Projects</h2>
  <!-- existing content -->
</div>

<!-- -------------------- SCRIPTS -------------------- -->
<script>
/* --- helpers --- */
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='dashboards'&&mapOffers){setTimeout(()=>mapOffers.invalidateSize(),100)}}
function scrollToSection(id){const el=document.getElementById(id);if(el){showPage('dashboards');el.scrollIntoView({behavior:'smooth'})}}
async function fetchCsv(u){const r=await fetch(u);if(!r.ok)throw`fetch ${u}`;return r.text()}
function parseCsv(t){return Papa.parse(t,{header:false,skipEmptyLines:true}).data.slice(1)}

/* --- toggle‑button helpers --- */
function setToggle(btn, label, active, txt){
  btn.classList.toggle('active',active);
  label.textContent = txt;
}

/* ---------- OFFERS ---------- */
let offersChart,offersMode='total';
function createOffersChart(){const ctx=document.getElementById('offersChart').getContext('2d');offersChart=new Chart(ctx,{type:'bar',data:{labels:dateLabels,datasets:[{label:'IA Générative',data:totalDataOffersGen},{label:'IA Générale',data:totalDataOffersGeneral},{label:'Computer Vision',data:totalDataOffersCV}]},options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true}}}});}
function toggleTotalShare(){
  offersMode=offersMode==='total'?'share':'total';
  offersChart.data.datasets[0].data=offersMode==='total'?totalDataOffersGen:shareDataOffersGen;
  offersChart.data.datasets[1].data=offersMode==='total'?totalDataOffersGeneral:shareDataOffersGeneral;
  offersChart.data.datasets[2].data=offersMode==='total'?totalDataOffersCV:shareDataOffersCV;
  offersChart.update();
  setToggle(document.getElementById('btnOfferMode'),document.getElementById('lblOfferMode'),offersMode==='share',offersMode.charAt(0).toUpperCase()+offersMode.slice(1));
}

/* ---------- SECTORS ---------- */
let sectorsChart,sectorsMode='total',sectorsAIType='genAI';
function createSectorsChart(){const ctx=document.getElementById('sectorsChart').getContext('2d');sectorsChart=new Chart(ctx,{type:'bar',data:{labels:sectorsLabels,datasets:[{label:'Industrie',data:[]},{label:'Services',data:[]}]},options:{responsive:true}});updateSectorsChart()}
function updateSectorsChart(){let ind,serv;if(sectorsMode==='total'&&sectorsAIType==='genAI'){ind=industryTotalGen;serv=serviceTotalGen}else if(sectorsMode==='total'){ind=industryTotalNonGen;serv=serviceTotalNonGen}else if(sectorsAIType==='genAI'){ind=industryShareGen;serv=serviceShareGen}else{ind=industryShareNonGen;serv=serviceShareNonGen}sectorsChart.data.datasets[0].data=ind;sectorsChart.data.datasets[1].data=serv;sectorsChart.update()}
function toggleSectorsTotalShare(){sectorsMode=sectorsMode==='total'?'share':'total';updateSectorsChart();setToggle(document.getElementById('btnSectorMode'),document.getElementById('lblSectorMode'),sectorsMode==='share',sectorsMode.charAt(0).toUpperCase()+sectorsMode.slice(1))}
function toggleSectorsGenNonGen(){sectorsAIType=sectorsAIType==='genAI'?'nonGenAI':'genAI';updateSectorsChart();setToggle(document.getElementById('btnSectorCat'),document.getElementById('lblSectorCat'),sectorsAIType!=='genAI',sectorsAIType==='genAI'?'Gen AI':'Non‑Gen')}

/* ---------- FIRM‑SIZE PIE ---------- */
let sizeChart,sizeAiType='ai';
function createSizeChart(){const ctx=document.getElementById('sizeChart').getContext('2d');sizeChart=new Chart(ctx,{type:'pie',data:{labels:sizeLabels,datasets:[{data:shareSizeAi}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});}
function toggleSizeAiGen(){sizeAiType=sizeAiType==='ai'?'gen':'ai';sizeChart.data.datasets[0].data=sizeAiType==='ai'?shareSizeAi:shareSizeGen;sizeChart.update();setToggle(document.getElementById('btnSizeCat'),document.getElementById('lblSizeCat'),sizeAiType==='gen','Gen AI')}

/* ---------- MAP ---------- */
let mapOffers,mapOffersMode='total',mapOffersAI='ai';
function createMapOffers(){mapOffers=L.map('mapOffers').setView([46.8,2],6);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(mapOffers);mapData.forEach(r=>{try{const g=JSON.parse(r.geometry);const l=L.geoJSON(g,{style:{fillColor:'#ccc',color:'#888',weight:1,fillOpacity:.6}}).addTo(mapOffers);l.bindPopup(`<b>${r['Nom Officiel Zone emploi 2020']}</b><br/>AI: ${r.ia}<br/>Share AI: ${r.ia_rel}<br/>GenAI: ${r['ia générative']}<br/>Share GenAI: ${r['ia générative_rel']}`);mapGeoLayers.push({layer:l,rowData:r})}catch{}});recolorMap()}
function pickColor(v){if(isNaN(v))return'#ccc';if(v<10)return'#fee5d9';if(v<50)return'#fcae91';if(v<200)return'#fb6a4a';if(v<500)return'#de2d26';return'#a50f15'}
function toggleMapTotalShare(){mapOffersMode=mapOffersMode==='total'?'share':'total';recolorMap();setToggle(document.getElementById('btnMapMode'),document.getElementById('lblMapMode'),mapOffersMode==='share',mapOffersMode.charAt(0).toUpperCase()+mapOffersMode.slice(1))}
function toggleMapAiGen(){mapOffersAI=mapOffersAI==='ai'?'gen':'ai';recolorMap();setToggle(document.getElementById('btnMapCat'),document.getElementById('lblMapCat'),mapOffersAI==='gen','Gen AI')}
function recolorMap(){let c;if(mapOffersAI==='ai'&&mapOffersMode==='total'){c='ia'}else if(mapOffersAI==='ai'){c='ia_rel'}else if(mapOffersMode==='total'){c='ia générative'}else{c='ia générative_rel'}mapGeoLayers.forEach(o=>{const v=parseFloat(o.rowData[c]);o.layer.setStyle({fillColor:pickColor(v)})})}

/* ---------- DATA ARRAYS (declared here for brevity) ---------- */
let dateLabels=[],totalDataOffersGen=[],totalDataOffersGeneral=[],totalDataOffersCV=[],shareDataOffersGen=[],shareDataOffersGeneral=[],shareDataOffersCV=[];
let sectorsLabels=[],industryTotalGen=[],serviceTotalGen=[],industryTotalNonGen=[],serviceTotalNonGen=[],industryShareGen=[],serviceShareGen=[],industryShareNonGen=[],serviceShareNonGen=[];
let sizeLabels=[],shareSizeAi=[],shareSizeGen=[];
let mapGeoLayers=[],mapData=[];

/* ---------- LOAD CSVs & BUILD ---------- */
window.onload=async()=>{try{
  /* home page */
  const g=parseCsv(await fetchCsv('data/general_results.csv'));const d={};g.forEach(r=>d[r[0]]=+r[1]||0);
  document.getElementById('aiOffersValue').textContent=d["Total IA offers"]||0;
  document.getElementById('aiOffersLastQuarter').textContent=`+${d["Number of AI offers in last quarter"]||0} offers last quarter`;
  document.getElementById('aiFirmsValue').textContent=d["Number of firms with AI offers"]||0;
  document.getElementById('aiFirmsLastQuarter').textContent=`+${d["Number of new AI adopters in last quarter"]||0} new firms last quarter`;
  document.getElementById('genAiOffersValue').textContent=d["Total IA générative offers"]||0;
  document.getElementById('genAiOffersLastQuarter').textContent=`+${d["Number of GenAI offers in last quarter"]||0} offers last quarter`;
  document.getElementById('genAiFirmsValue').textContent=d["Number of firms with GenAI offers"]||0;

  /* offers csvs */
  parseCsv(await fetchCsv('data/offers_total.csv')).forEach(r=>{const i=parseInt(r[0]);dateLabels.push(monthLabel(i));totalDataOffersGen.push(+r[1]);totalDataOffersGeneral.push(+r[2]);totalDataOffersCV.push(+r[3])});
  parseCsv(await fetchCsv('data/offers_share.csv')).forEach(r=>{shareDataOffersGen.push(+r[1]);shareDataOffersGeneral.push(+r[2]);shareDataOffersCV.push(+r[3])});

  /* sectors */
  parseCsv(await fetchCsv('data/two_sectors_total_gen.csv')).forEach(r=>{const idx=parseInt(r[0]);if(sectorsLabels.length<=idx)sectorsLabels.push(quarterLabel(idx));industryTotalGen.push(+r[1]);serviceTotalGen.push(+r[2])});
  parseCsv(await fetchCsv('data/two_sectors_total_nongen.csv')).forEach(r=>{industryTotalNonGen.push(+r[1]);serviceTotalNonGen.push(+r[2])});
  parseCsv(await fetchCsv('data/two_sectors_share_gen.csv')).forEach(r=>{industryShareGen.push(+r[1]);serviceShareGen.push(+r[2])});
  parseCsv(await fetchCsv('data/two_sectors_share_nongen.csv')).forEach(r=>{industryShareNonGen.push(+r[1]);serviceShareNonGen.push(+r[2])});

  /* firm‑size csv */
  parseCsv(await fetchCsv('data/distrib_size.csv')).forEach(r=>{sizeLabels.push(r[0]);shareSizeAi.push(+r[1]);shareSizeGen.push(+r[2])});

  /* map csv */
  parseCsv(await fetchCsv('data/map_offers.csv')).forEach(r=>mapData.push({'Nom Officiel Zone emploi 2020':r[0],geometry:r[1],ia:r[2],ia_rel:r[3],'ia générative':r[4],'ia générative_rel':r[5],total_offers:r[6]}));

  /* build visuals */
  createOffersChart();createSectorsChart();createSizeChart();createMapOffers();
}catch(e){console.error(e)}};
</script>
</body>
</html>
