<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI-Tracker</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- D3 & TopoJSON (map) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
  /* =========================
     DESIGN SYSTEM (Navy theme)
     ========================= */
  :root{
    /* brand */
    --brand-900:#0b1f3a;
    --brand-800:#132a4a;
    --brand-700:#1c3a63;
    --brand-600:#274b7a;
    --brand-500:#2f5f9a;
    --brand-300:#7ea7d8;
    --brand-100:#e9f0f8;

    /* neutrals */
    --ink-900:#0f172a;
    --ink-700:#1f2937;
    --ink-600:#334155;
    --ink-500:#475569;
    --ink-400:#94a3b8;
    --ink-300:#cbd5e1;

    /* surfaces */
    --card-bg:#ffffff;
    --card-border:#e5e7eb;
    --shadow: 0 10px 25px rgba(2,12,27,.08);
    --radius: 14px;
  }

  /* Background + typography */
  html, body {
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--ink-900);
    background:
      radial-gradient(1200px 800px at 10% -10%, rgba(47,95,154,.08), transparent 50%),
      radial-gradient(1000px 600px at 110% 10%, rgba(19,42,74,.06), transparent 45%),
      #ffffff;
  }

  *{ box-sizing:border-box }

  /* =========================
     HEADER + NAV
     ========================= */
header{
  background: linear-gradient(135deg, color-mix(in oklab, var(--brand-900), #000 10%), var(--brand-700));
  padding: var(--header-pad-y) 18px;   /* was: 20px 18px */
  position: sticky; top: 0; z-index: 10;
  border-bottom: 1px solid rgba(255,255,255,.08);
  backdrop-filter: saturate(140%) blur(8px);
}
  .header-top{
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 12px;            /* a bit tighter than 16px */
  min-height: 0;        /* don’t force extra height */
}

  .left-block,.center-block,.right-block{ flex:1; min-height:50px }
  .left-block{ display:flex; align-items:center }
  .logo{ height:72px; width:auto; margin-left:6px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.15)); }
  .center-block{ display:flex; justify-content:center; align-items:center; pointer-events:none }
  .center-block h1{ margin:0; font-size:1.9rem; font-weight:700; letter-spacing:.2px }
.logo--center{
  height: var(--logo-size);  /* was fixed pixels */
  width: auto;
  margin: 0;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.15));
}
nav{
  display:flex; justify-content:center; gap:12px;
  margin: var(--nav-gap-top) 0 0;   /* was: margin-top:12px; */
  flex-wrap: wrap;
}
  nav button{
    padding:10px 16px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.25);
    background: rgba(255,255,255,.10);
    color:#fff;
    cursor:pointer;
    backdrop-filter: saturate(140%) blur(4px);
    transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
  }
  nav button:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.18);
    box-shadow: 0 8px 16px rgba(0,0,0,.15);
  }

  /* =========================
     LAYOUT (pages/sections)
     ========================= */
  .page{ display:none; padding:20px }
  .page.active{ display:block }

  /* “Carded” sections */
  .chart-section, .additional-figures{
    background: var(--card-bg);
    border:1px solid var(--card-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:24px;
    margin: 28px auto;
    max-width:1100px;
    transition: box-shadow .2s ease, border-color .2s ease;
  }
  .chart-section:hover{ box-shadow: 0 16px 34px rgba(2,12,27,.12) }

  /* Hero / intro */
  #accueil .welcome-title{
    text-align:center; margin-top:30px; line-height:1.3em;
  }
  #accueil .welcome-title .subtitle{
    display:block; margin-top:6px; font-size:1rem; font-weight:400; color:var(--ink-600);
  }
  .explanation{
    max-width:900px; margin:24px auto 8px; line-height:1.55em; text-align:center; color:var(--ink-700);
  }

  /* Headings */
  #dashboards h2, .figures-title{
    text-align:center; margin: 26px 0 6px; font-size:1.9rem; font-weight:700; color:var(--brand-900);
  }
  .chart-section h3{
    margin:0 0 10px; font-size:1.25rem; font-weight:700; color:var(--brand-800);
  }
  .dashboard-intro{
    max-width:850px; margin:0 auto 18px; text-align:center; font-size:.98rem; color:var(--ink-600);
  }

  /* Grid for key figures */
  .additional-figures{ max-width:1100px; }
  .figures-row{ display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-bottom:18px }
  .key-figure-card{
    border:1px solid var(--card-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:18px 18px 16px;
    width: 240px;
    text-align:center;
    background:#fff;
  }
  .key-figure-card h4{ color:var(--brand-700); margin:0 0 6px }
  .key-figure-card p:first-of-type{ font-size:2rem; font-weight:700; color:var(--brand-900); margin: 6px 0 }
  .key-figure-card small{ color:var(--ink-600) }
  .key-figure-card.clickable{ cursor:pointer; transition: transform .15s ease, box-shadow .15s ease }
  .key-figure-card.clickable:hover{
    transform: translateY(-3px);
    box-shadow: 0 14px 28px rgba(19,42,74,.12);
  }

  /* Sub-navigation inside Dashboards */
  .sub-nav{
    text-align:center; margin-bottom:20px;
  }
  .sub-nav button{
    margin:6px; background:#f3f6fb; color:var(--brand-700);
    border:1px solid #dbe3ef; border-radius:999px; cursor:pointer;
    padding:8px 14px; font-weight:600;
    transition: background .2s ease, transform .15s ease, box-shadow .2s ease;
  }
  .sub-nav button:hover{
    transform: translateY(-1px);
    background:#e9f0f8;
    box-shadow:0 8px 16px rgba(19,42,74,.08);
  }

  /* Chart containers */
  .chart-container{ max-width:1800px; margin:0 auto }
  #sizeSection   .chart-container{ max-width:400px; height:400px }
  #metierSection .chart-container{ max-width:1000px; height:900px }
  #skillsSection .chart-container{ max-width:1000px; height:600px }
  #mapOffersSection .map-container{
    width:100%;
    max-width:1100px;
    height:720px;
    margin: 0 auto;
  }

  /* Toggles */
  .chart-controls{ display:flex; justify-content:center; align-items:center; gap:12px; margin:10px 0 }
  .toggle-btn{
    position:relative; display:inline-block;
    width:84px; height:32px; border:none; border-radius:999px;
    background:var(--ink-400); cursor:pointer; transition: background .2s;
  }
  .toggle-btn .slider{
    position:absolute; top:4px; left:4px; width:24px; height:24px; border-radius:50%;
    background:#fff; transition:left .25s;
  }
  .toggle-btn.active{ background: var(--brand-500) }
  .toggle-btn.active .slider{ left:56px }
  .toggle-label{ margin-left:6px; font-size:14px; font-weight:700; color: var(--ink-600) }

  /* Three-way toggle buttons */
  .tri-toggle .evol-btn{
    border:1px solid #dbe3ef; border-right:none; padding:7px 16px;
    background:#f3f6fb; color:var(--brand-700);
    font-weight:700; cursor:pointer;
  }
  .tri-toggle .evol-btn:last-child{ border-right:1px solid #dbe3ef }
  .tri-toggle .evol-btn.active{ background:var(--brand-500); color:#fff; border-color:transparent }

  /* Map legend axis text color (match theme) */
  #mapLegend .tick text{ fill: var(--ink-600); font-size:12px }

:root{
  --space-1: .5rem;  --space-2: .75rem; --space-3: 1rem; --space-4: 1.5rem; --space-6: 2rem;
  --fs-0: clamp(.94rem, .9rem + .2vw, 1.05rem);
  --fs-1: clamp(1.1rem, 1rem + .6vw, 1.4rem);
  --fs-2: clamp(1.5rem, 1.2rem + 1.2vw, 2rem);
  --radius: 16px;
  --shadow-lg: 0 20px 50px rgba(2,12,27,.12);
}
html { scroll-behavior:smooth; }
body { font-size: var(--fs-0); line-height: 1.55; }
header{
  background: linear-gradient(135deg, color-mix(in oklab, var(--brand-900), #000 10%), var(--brand-700));
  backdrop-filter: saturate(140%) blur(8px);
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.chart-section, .additional-figures{ border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: var(--space-4); }
#dashboards h2, .figures-title { font-size: var(--fs-2); }
.chart-section h3 { font-size: var(--fs-1); }

/* Primary nav underline for current page */
nav button{ position:relative; }
nav button::after{
  content:""; position:absolute; left:12px; right:12px; bottom:-6px; height:2px;
  background:#fff; border-radius:2px; transform:scaleX(0); transform-origin:left; transition:transform .25s;
}
nav button[aria-selected="true"]::after{ transform:scaleX(1); }

/* Sub-nav active state (used by scrollspy) */
.sub-nav button.active{
  background: var(--brand-500); color: #fff; border-color: transparent;
  box-shadow: 0 10px 24px rgba(47,95,154,.25);
}

/* KPI delta badge */
.key-figure-card{ position:relative; overflow:hidden; isolation:isolate; }
.key-figure-card::before{
  content:""; position:absolute; inset:auto 0 0 0; height:36%;
  background: linear-gradient(180deg, transparent, color-mix(in oklab, var(--brand-100), #fff 20%));
  z-index:0;
}
.badge-delta{
  display:inline-flex; align-items:center; gap:6px;
  background: #10b9811a; color:#059669; border:1px solid #05966933;
  padding:2px 8px; border-radius:999px; font-weight:600; font-size:.85em;
}

/* Toggles feel */
.toggle-btn{ box-shadow: inset 0 2px 8px rgba(0,0,0,.12); }
.toggle-btn .slider{ box-shadow: 0 3px 10px rgba(0,0,0,.25); }
.evol-btn{ transition: transform .15s ease; }
.evol-btn:hover{ transform: translateY(-1px); }

/* Chart readability */
:root { --grid: rgba(148,163,184,.25); --grid-strong: rgba(148,163,184,.35); }

/* Map tip + legend polish */
#mapTip{
  position:fixed; inset:auto auto 16px 16px;
  background: var(--card-bg); color: var(--ink-900);
  border:1px solid var(--card-border); border-radius: 12px;
  padding:10px 12px; box-shadow: var(--shadow);
  min-width: 220px; z-index:10; pointer-events:none;
}
#mapLegend svg{ filter: drop-shadow(0 4px 12px rgba(2,12,27,.12)); }

/* Reveal on scroll */
@keyframes fadeUp { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
.reveal { opacity:0; transform:translateY(10px); }
.reveal.is-in { animation: fadeUp .5s ease-out forwards; }
@media (prefers-reduced-motion: reduce){ .reveal{opacity:1; transform:none; animation:none} }

/* Perf: skip layout for off-screen pages */
.page:not(.active){ content-visibility: auto; contain-intrinsic-size: 800px; }

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root {
    --card-bg:#0b1220; --card-border:#1a2234;
    --ink-900:#e5e9f2; --ink-700:#c8d2e1; --ink-600:#9fb2ce; --ink-500:#8aa0c2;
    --shadow: 0 10px 25px rgba(0,0,0,.4);
  }
  body { background: radial-gradient(1200px 800px at 10% -10%, rgba(47,95,154,.15), transparent 50%), #080d17; }
  nav button { border-color: rgba(255,255,255,.12); background: rgba(255,255,255,.06); }
  .key-figure-card { background: var(--card-bg); }
}

/* Make center area clickable (was pointer-events:none) */
.center-block { display:flex; justify-content:center; align-items:center; pointer-events:auto; }

/* Optional: focus ring for keyboard users */
.brand { display:inline-flex; align-items:center; border-radius:12px; outline: none; }
.brand:focus-visible { outline: 2px solid #fff; outline-offset: 4px; }

/* Small screens: slightly smaller logo */
@media (max-width: 640px){
  .logo--center { height:56px; }
}

/* If you keep the old left logo in code, hide it: */
.left-block .logo { display:none; }

 /* Center the whole header content and give it a max width */
/* Stack logo row + nav and control the gap */
.header-wrap{
  max-width: 1100px;
  margin: 0 auto;
  display: flex;                 /* NEW */
  flex-direction: column;        /* NEW */
  align-items: center;           /* NEW */
  row-gap: var(--nav-gap-top);   /* NEW → controls distance */
}

/* Remove margin between logo and nav */
.header-wrap > nav{ margin: 0; } /* NEW */


/* Perfect centering for the middle cell with CSS Grid */
.header-top{
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* left | center | right */
  align-items: center;
  gap: 16px;
  min-height: 50px;
}

/* Keep left/right as flex containers in case you add things later */
.left-block, .right-block{ display:flex; align-items:center; }

/* Center cell is clickable (remove the earlier pointer-events:none) */
.center-block{ display:flex; justify-content:center; align-items:center; }


/* Make the logo a11y-friendly when tabbed */
.brand{ display:inline-flex; align-items:center; border-radius:12px; outline:none; }
.brand:focus-visible{ outline:2px solid #fff; outline-offset:4px; }



/* Responsive: slightly smaller logo on small screens */
@media (max-width: 640px){
  .logo--center{ height: 64px; }
}
   
 :root{
  --logo-size: 196px;      /* ← make bigger/smaller */
  --header-pad-y: 10px;   /* ← vertical padding of header */
  --nav-gap-top: 1px;     /* ← space between logo row and buttons */
}

    /* put this near the bottom of your <style>, AFTER any other .logo/.logo--center rules */
.logo.logo--center{
  height: var(--logo-size) !important; /* force it to win over earlier duplicates */
  width: auto;
  margin: 0;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.15));
}

    /* Put this near the bottom of <style> so it wins */
.header-wrap > nav{
  margin: var(--nav-gap-top) 0 0 !important; /* force override */
}
    
  </style>

  <!-- Chart.js global theme defaults -->
  <script>
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
    Chart.defaults.color = '#334155';
    Chart.defaults.elements.line.borderWidth = 2;
    Chart.defaults.elements.point.radius = 0;
    Chart.defaults.plugins.legend.labels.boxWidth = 14;
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.92)';
    Chart.defaults.plugins.tooltip.titleColor = '#fff';
    Chart.defaults.plugins.tooltip.bodyColor = '#fff';
      // Extra polish
  Chart.defaults.borderColor = getComputedStyle(document.documentElement)
    .getPropertyValue('--grid-strong') || 'rgba(148,163,184,.35)';
  Chart.defaults.scales = Chart.defaults.scales || {};
  if (Chart.defaults.scales.linear) {
    Chart.defaults.scales.linear.grid.color = getComputedStyle(document.documentElement)
      .getPropertyValue('--grid') || 'rgba(148,163,184,.25)';
  }
  Chart.defaults.animation.duration = 700;
  Chart.defaults.animation.easing = 'easeOutCubic';
  Chart.defaults.plugins.legend.labels.usePointStyle = true;
  Chart.defaults.plugins.legend.labels.pointStyle = 'circle';
  Chart.defaults.locale = 'fr-FR';

  // Rounded bar plugin
  const roundedBar = {
    id:'roundedBar',
    beforeDatasetsDraw(chart){
      chart.data.datasets.forEach((ds, i)=>{
        const meta = chart.getDatasetMeta(i);
        if (meta.type !== 'bar') return;
        meta.data.forEach(bar => { bar.options.borderRadius = 8; });
      });
    }
  };
  Chart.register(roundedBar);
  </script>
</head>
<body>

<header>
  <div class="header-wrap">
    <div class="header-top">
      <div class="left-block"><!-- empty on purpose --></div>

      <div class="center-block">
        <a class="brand" href="#accueil" onclick="showPage('accueil'); return false;" aria-label="Go to Overview">
          <img src="logo.png" alt="AI-Tracker logo" class="logo logo--center">
        </a>
      </div>

      <div class="right-block"><!-- empty on purpose, for symmetry --></div>
    </div>

    <nav role="tablist" aria-label="Primary">
      <button role="tab" aria-selected="true" tabindex="0" onclick="showPage('accueil')">Overview</button>
      <button role="tab" aria-selected="false" tabindex="-1" onclick="showPage('dashboards')">Data</button>
      <button role="tab" aria-selected="false" tabindex="-1" onclick="showPage('projects')">About</button>
    </nav>
  </div>
</header>


<!-- ======= HOME (Accueil) ======= -->
<div id="accueil" class="page active">
  <h2 class="welcome-title">
    Welcome to our AI-tracker!
    <span class="subtitle">A real-time dashboard tracking how artificial intelligence spreads through the French economy.</span>
  </h2>

  <div class="explanation">
    <p>The French AI-tracker is an open-access <strong>research project</strong> that monitors, almost in real time, the diffusion of artificial-intelligence technologies within French companies.</p>
    <p>Using machine-learning models to sift through millions of job ads in the
       <a href="https://dares.travail-emploi.gouv.fr/enquete-source/job-offers-collection-and-analysis-system" target="_blank" rel="noopener noreferrer">JOCAS</a> database (DARES), we detect every vacancy that signals an AI-related role and thus detect gradual AI adoption. By updating the figures each week, we provide researchers, journalists, policymakers and citizens with a transparent window onto <em>where</em>, <em>how fast</em> and in <em>which form</em> AI is reshaping the labour market.</p>
  </div>

  <h3 class="figures-title">Key figures at a glance</h3>
  <div class="additional-figures">
    <div class="figures-row">
      <div class="key-figure-card clickable" onclick="scrollToSection('totalOffersSection')">
        <h4>Total AI Offers</h4>
        <p id="aiOffersValue">…</p>
        <p><small id="aiOffersLastQuarter">…</small></p>
      </div>
      <div class="key-figure-card clickable" onclick="scrollToSection('sectorsSection')">
        <h4>Total AI Adopters</h4>
        <p id="aiFirmsValue">…</p>
        <p><small id="aiFirmsLastQuarter">…</small></p>
      </div>
    </div>
    <div class="figures-row">
      <div class="key-figure-card clickable" onclick="scrollToSection('totalOffersSection')">
        <h4>Total GenAI Offers</h4>
        <p id="genAiOffersValue">…</p>
        <p><small id="genAiOffersLastQuarter">…</small></p>
      </div>
      <div class="key-figure-card clickable" onclick="scrollToSection('sectorsSection')">
        <h4>Total GenAI Adopters</h4>
        <p id="genAiFirmsValue">…</p>
        <p><small id="genAiFirmsLastQuarter">…</small></p>
      </div>
    </div>
  </div>
</div>

<!-- ==========  DASHBOARDS  ========== -->
<div id="dashboards" class="page">
  <h2>Dashboards</h2>
  <p class="dashboard-intro">
    All statistics and visualisations on this page are produced from the JOCAS job-posting database using advanced
    machine-learning methods to detect and classify AI-related vacancies.
  </p>

  <div class="sub-nav">
    <button onclick="scrollToSection('totalOffersSection')">Total Offers</button>
    <button onclick="scrollToSection('sectorsSection')">Sectors</button>
    <button onclick="scrollToSection('sizeSection')">Firm-size</button>
    <button onclick="scrollToSection('metierSection')">Métiers</button>
    <button onclick="scrollToSection('skillsSection')">Skills</button>
    <button onclick="scrollToSection('mapOffersSection')">Map</button>
  </div>

  <!-- TOTAL OFFERS -->
  <div id="totalOffersSection" class="chart-section">
    <h3>Evolution of AI-Related Job Offers</h3>
    <div class="chart-controls">
      <button id="btnOfferMode" class="toggle-btn" onclick="toggleTotalShare()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblOfferMode">Total</span>
    </div>
    <div class="chart-container"><canvas id="offersChart"></canvas></div>
  </div>

  <!-- SECTORS -->
  <div id="sectorsSection" class="chart-section">
    <h3>Firms Adopting AI by Sector</h3>
    <div class="chart-controls">
      <button id="btnSectorMode" class="toggle-btn" onclick="toggleSectorsTotalShare()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSectorMode">Total</span>
      <button id="btnSectorCat" class="toggle-btn" onclick="toggleSectorsGenNonGen()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSectorCat">Gen AI</span>
    </div>
    <div class="chart-container"><canvas id="sectorsChart"></canvas></div>

    <h3 style="margin-top:60px;">Sector Share in Published Offers</h3>
    <div class="chart-controls tri-toggle">
      <button class="evol-btn active" id="btnAI"  onclick="setEvolType('ai')">AI</button>
      <button class="evol-btn"        id="btnGen" onclick="setEvolType('gen')">GenAI</button>
      <button class="evol-btn"        id="btnAll" onclick="setEvolType('all')">All</button>
    </div>
    <div class="chart-container"><canvas id="sectorEvolChart"></canvas></div>
  </div>

  <!-- SIZE -->
  <div id="sizeSection" class="chart-section">
    <h3>Distribution of AI Adopters by Firm Size</h3>
    <div class="chart-controls">
      <button id="btnSizeCat" class="toggle-btn" onclick="toggleSizeAiGen()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSizeCat">AI</span>
    </div>
    <div class="chart-container"><canvas id="sizeChart"></canvas></div>
  </div>

  <!-- MÉTIERS -->
  <div id="metierSection" class="chart-section">
    <h3>AI Offers by Métiers (ROME)</h3>
    <div class="chart-controls">
      <button id="btnMetierCat" class="toggle-btn" onclick="toggleMetier()">
        <span class="slider"></span>
      </button>
      <span class="toggle-label" id="lblMetierCat">IA</span>
    </div>
    <div class="chart-container">
      <canvas id="metierChart"></canvas>
    </div>
  </div>

  <!-- SKILLS -->
  <div id="skillsSection" class="chart-section">
    <h3>Evolution of Skills in AI Job Ads</h3>
    <div class="chart-controls tri-toggle">
      <button class="evol-btn active" id="btnSkillsLibraries" onclick="setSkillsType('ml_library')">ML Libraries</button>
      <button class="evol-btn"        id="btnSkillsMethods"  onclick="setSkillsType('method_skills')">Methods</button>
      <button class="evol-btn"        id="btnSkillsBroad"    onclick="setSkillsType('broad_skills')">Broad skills</button>
    </div>
    <div class="chart-container">
      <canvas id="skillsChart"></canvas>
    </div>
  </div>

  <!-- MAP -->
  <div id="mapOffersSection" class="chart-section">
    <h3>Map of French Zones d’Emplois</h3>
    <div class="chart-controls">
      <button id="btnMapMode" class="toggle-btn" onclick="toggleMapTotalShare()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblMapMode">Total</span>
      <button id="btnMapCat" class="toggle-btn" onclick="toggleMapAiGen()"><span class="slider"></span></button>
      <span class="toggle-label" id="lblMapCat">AI</span>
    </div>
    <div class="map-container" id="mapOffers"></div>
    <div id="mapLegend" style="max-width:1100px;margin:8px auto 0;"></div>
  </div>
</div>

<!-- ==========  PROJECTS  ========== -->
<div id="projects" class="page">
  <h2>Projects</h2>
  <section class="authors">
    <h3>Authors</h3>
    <p>The AI-tracker is the work of :</p>
    <ul>
      <li><strong><a href="https://www.linkedin.com/in/paul-delbouve-180b19268/" target="_blank" rel="noopener noreferrer">Paul Delbouve</a></strong> — Collège de France, PSE, DGE (Ministère de l’Économie et des Finances)</li>
    </ul>
    <p>With the strong support of :</p>
    <ul>
      <li><strong><a href="https://sites.google.com/site/abergeaudeco" target="_blank" rel="noopener noreferrer">Antonin Bergeaud</a></strong> — HEC Paris, LSE, CEPR</li>
      <li><strong><a href="https://www.insead.edu/faculty/philippe-aghion" target="_blank" rel="noopener noreferrer">Philippe Aghion</a></strong> — Collège de France, INSEAD, LSE, CEPR</li>
      <li><strong><a href="https://sites.google.com/view/simon-bunel/home" target="_blank" rel="noopener noreferrer">Simon Bunel</a></strong> — Collège de France, Banque de France</li>
    </ul>
  </section>

  <section class="papers">
    <h3>Academic Papers</h3>
    <p><strong>Diffusion de l'Intelligence Artificielle en France</strong> Aghion, P., Bergeaud, A., Bunel, S., & Delbouve, P. (2025) <em>Economie et Statistique/Economics and Statistics</em> (forthcoming)</p>
  </section>
</div>

<!-- ==========  SCRIPTS  ========== -->
<script>
/* ---------- helpers ---------- */
function setActiveTab(id, btn){
  document.querySelectorAll('nav [role="tab"]').forEach(b=>{
    const sel = b === btn;
    b.setAttribute('aria-selected', sel);
    b.tabIndex = sel ? 0 : -1;
    // If you kept the aria-current underline:
    // if (sel) b.setAttribute('aria-current','page'); else b.removeAttribute('aria-current');
  });
}

function showPage(id){
  // 1) swap visible page
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const next = document.getElementById(id);
  next.classList.add('active');

  // 2) sync tabs
  const btn = [...document.querySelectorAll('nav [role="tab"]')]
    .find(b=>b.getAttribute('onclick')?.includes(id));
  if (btn) setActiveTab(id, btn);

  // 3) force scroll to top AFTER layout updates
  const prevBehavior = document.documentElement.style.scrollBehavior;
  document.documentElement.style.scrollBehavior = 'auto'; // avoid smooth-keeping at bottom

  // Let the browser apply styles and compute new layout, then scroll.
  requestAnimationFrame(()=>{
    // anchor to the top of the newly active page (works even if header is sticky)
    next.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'auto' });

    // also zero the document scroll to be extra safe
    const scroller = document.scrollingElement || document.documentElement;
    scroller.scrollTop = 0;

    // restore any previous smooth-scroll preference
    document.documentElement.style.scrollBehavior = prevBehavior || '';
  });

  // 4) any page-specific fixes
  if (id === 'dashboards' && typeof updateLegend === 'function') {
    // tiny delay so the SVG can size correctly
    setTimeout(updateLegend, 50);
  }
}

/* ---------- load figures for the Home page ---------- */
async function loadHome(){
  try{
    const rows = parseCsv(await fetchCsv('data/general_results.csv'));
    const d    = rows.reduce((h,r)=>(h[r[0]]=+r[1]||0, h),{});

    aiOffersValue.textContent        = d['Total IA offers']                    ?? '0';
    aiOffersLastQuarter.textContent  = `+${d['Number of AI offers in last quarter']   ?? 0} offers last quarter`;
    aiFirmsValue.textContent         = d['Number of firms with AI offers']     ?? '0';
    aiFirmsLastQuarter.textContent   = `+${d['Number of new AI adopters in last quarter'] ?? 0} new firms last quarter`;

    genAiOffersValue.textContent     = d['Total IA générative offers']         ?? '0';
    genAiOffersLastQuarter.textContent=`+${d['Number of GenAI offers in last quarter'] ?? 0} offers last quarter`;
    genAiFirmsValue.textContent      = d['Number of firms with GenAI offers']  ?? '0';
    genAiFirmsLastQuarter.textContent=`+${d['Number of new GenAI adopters in last quarter'] ?? 0} new firms last quarter`;
  }catch(e){
    console.error('Error loading home figures:', e);
  }
}

const fetchCsv=url=>fetch(url).then(r=>{if(!r.ok)throw url;return r.text()});
const parseCsv=txt=>Papa.parse(txt,{header:false,skipEmptyLines:true}).data.slice(1);
const monthLabel=i=>`${2019+Math.floor(i/12)}-${String((i%12)+1).padStart(2,'0')}`;
const quarterLabel=i=>`Q${(i%4)+1} ${2019+Math.floor(i/4)}`;
const pastel=i=>`hsl(${(i*40)%360},45%,72%)`;

/* ---------- custom palette for Métiers ---------- */
const metierPalette = [
  'rgba(31,119,180,1.0)','rgba(174,199,232,1.0)','rgba(255,127,14,1.0)','rgba(255,187,120,1.0)',
  'rgba(44,160,44,1.0)','rgba(152,223,138,1.0)','rgba(214, 39, 40,1.0)','rgba(255,152,150,1.0)',
  'rgba(148,103,189,1.0)','rgba(196,172,228,1.0)','rgba(140, 86, 75,1.0)','rgba(196,156,148,1.0)',
  'rgba(227,119,194,1.0)','rgba(247,182,210,1.0)','rgba(127,127,127,1.0)','rgba(199,199,199,1.0)',
  'rgba(188,189, 34,1.0)','rgba(219,219,141,1.0)','rgba( 23,190,207,1.0)','rgba(158,218,229,1.0)',
  'rgba( 57, 59,121,1.0)','rgba( 82, 84,163,1.0)','rgba(107,110,207,1.0)','rgba(156,158,222,1.0)',
  'rgba( 99,121, 57,1.0)','rgba(140,162, 82,1.0)','rgba(181,207,107,1.0)','rgba(206,219,156,1.0)',
  'rgba(140,109, 49,1.0)','rgba(189,158, 57,1.0)','rgba( 49,130,189,1.0)','rgba(107,174,214,1.0)',
  'rgba(158,202,225,1.0)','rgba(198,219,239,1.0)','rgba(230, 85, 13,1.0)','rgba(253,141, 60,1.0)',
  'rgba(253,174,107,1.0)','rgba(253,208,162,1.0)','rgba( 49,163, 84,1.0)','rgba(116,196,118,1.0)'
];

/* ---------- data holders ---------- */
let dateLabels=[],totalGen=[],totalAI=[],totalCV=[],totalNLP=[],shareGen=[],shareAI=[],shareCV=[],shareNLP=[];
let qLabels=[],indTotGen=[],servTotGen=[],indTotNon=[],servTotNon=[],indShGen=[],servShGen=[],indShNon=[],servShNon=[];
let sizeLabels=[],sizeAi=[],sizeGen=[];
let mapRows=[];
let evolDates=[],evolDatesGen=[],evolAI=[],evolGen=[],evolAll=[];
/* Métiers */
let metierDates=[],metierDatesData=[],metierIA=[],metierData=[];
/* Skills */
const skillsDates={ml_library:[],method_skills:[],broad_skills:[]};
const skillsSets ={ml_library:[],method_skills:[],broad_skills:[]};

/* ---------- number sanitizer for CSV ---------- */
const toNum = v => {
  if (v == null) return NaN;
  const n = Number(String(v).replace(/[%\s\u00A0]/g,'').replace(',', '.'));
  return Number.isFinite(n) ? n : NaN;
};

/* ---------- robust sector CSV loader (by header + date labels) ---------- */
async function loadTwoSectors(file, fillLabels, indArr, servArr){
  const parsed = Papa.parse(await fetchCsv(file), {
    header: true, skipEmptyLines: true, dynamicTyping: true
  }).data;

  if (fillLabels) {
    qLabels = parsed.map(r => r.date);   // use actual dates as x labels
  }
  parsed.forEach(r => {
    indArr.push(toNum(r.Industrie));
    servArr.push(toNum(r.Services));
  });
}

/* ---------- OFFERS chart ---------- */
let offersChart,offersMode='total';
function buildOffers(){
  offersChart=new Chart(document.getElementById('offersChart'),{
 type:'bar',
    data:{
      labels:dateLabels,
      datasets:[
        {label:'Generative AI',   data:totalGen, backgroundColor:'rgba(255,99,132,0.7)'},
        {label:'General AI',      data:totalAI,  backgroundColor:'rgba(75,192,192,0.7)'},
        {label:'Computer Vision', data:totalCV,  backgroundColor:'rgba(54,162,235,0.7)'},
        {label:'NLP',             data:totalNLP, backgroundColor:'rgba(153,102,255,0.7)'}
      ]
    },
    options:{responsive:true,scales:{x:{stacked:true},y:{stacked:true}}}
  });
}
function toggleTotalShare(){
  offersMode=offersMode==='total'?'share':'total';
  offersChart.data.datasets[0].data=offersMode==='total'?totalGen:shareGen;
  offersChart.data.datasets[1].data=offersMode==='total'?totalAI:shareAI;
  offersChart.data.datasets[2].data=offersMode==='total'?totalCV:shareCV;
  offersChart.data.datasets[3].data=offersMode==='total'?totalNLP:shareNLP;

  // NEW: axis label
  offersChart.options.scales.y.title = {
    display: true,
    text: offersMode==='total' ? 'Offers (count)' : 'Share of offers (%)'
  };

  offersChart.update();
  btnOfferMode.classList.toggle('active',offersMode==='share');
  lblOfferMode.textContent=offersMode.charAt(0).toUpperCase()+offersMode.slice(1);
}

/* ---------- SECTOR BAR ---------- */
let sectorsChart,secMode='total',secCat='gen';
function buildSectors(){
  sectorsChart=new Chart(document.getElementById('sectorsChart'),{
    type:'bar',
    data:{labels:qLabels,
      datasets:[
        {label:'Industrie',backgroundColor:'rgba(153,102,255,0.7)',data:[]},
        {label:'Services', backgroundColor:'rgba(255,205,86,0.7)',data:[]}
      ]},
    options:{responsive:true}
  });
  refreshSectors();
}
function refreshSectors(){
  let ind,serv;
  if(secMode==='total'&&secCat==='gen'){ind=indTotGen;serv=servTotGen}
  else if(secMode==='total'){ind=indTotNon;serv=servTotNon}
  else if(secCat==='gen'){ind=indShGen;serv=servShGen}
  else{ind=indShNon;serv=servShNon}
  sectorsChart.data.datasets[0].data=ind;
  sectorsChart.data.datasets[1].data=serv;
  sectorsChart.update();
}
function toggleSectorsTotalShare(){
  secMode=secMode==='total'?'share':'total';
  btnSectorMode.classList.toggle('active',secMode==='share');
  lblSectorMode.textContent=secMode.charAt(0).toUpperCase()+secMode.slice(1);
  refreshSectors();
}
function toggleSectorsGenNonGen(){
  secCat=secCat==='gen'?'nongen':'gen';
  btnSectorCat.classList.toggle('active',secCat!=='gen');
  lblSectorCat.textContent=secCat==='gen'?'Generative AI':'Non generative AI';
  refreshSectors();
}

/* ---------- SECTOR EVOLUTION ---------- */
let evolChart,evolType='ai';
function buildEvol(){
  evolChart=new Chart(document.getElementById('sectorEvolChart'),{
    type:'line',
    data:{labels:evolDates,datasets:evolAI},
    options:{responsive:true,scales:{y:{stacked:true}},elements:{line:{fill:true,tension:.3}}}
  });
}
function setEvolType(t){
  evolType=t;
  btnAI .classList.toggle('active',t==='ai');
  btnGen.classList.toggle('active',t==='gen');
  btnAll.classList.toggle('active',t==='all');
  if(t==='ai'){evolChart.data.labels=evolDates;evolChart.data.datasets=evolAI}
  else if(t==='gen'){evolChart.data.labels=evolDatesGen;evolChart.data.datasets=evolGen}
  else{evolChart.data.labels=evolDates;evolChart.data.datasets=evolAll}
  evolChart.update();
}

/* ---------- SIZE PIE ---------- */
let sizeChart, sizeCat = 'ai';

// simple pleasant palette (one color per slice)
const SIZE_COLORS = [
  '#2f5f9a', '#7ea7d8', '#94a3b8', '#cbd5e1', '#274b7a', '#1c3a63', '#a3bce3'
];
// if you want it to auto-extend for any number of labels:
const colorsFor = n => Array.from({length:n}, (_,i)=> SIZE_COLORS[i % SIZE_COLORS.length]);

function buildSize(){
  const data = sizeAi; // initial mode = 'ai'
  const bg   = colorsFor(sizeLabels.length);

  sizeChart = new Chart(document.getElementById('sizeChart'),{
    type:'pie',
    data:{
      labels: sizeLabels,
      datasets:[{
        data: data,
        backgroundColor: bg,
        borderWidth: 0,
        hoverOffset: 6
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ position:'bottom' } }
    }
  });
}

function toggleSizeAiGen(){
  sizeCat = (sizeCat === 'ai') ? 'gen' : 'ai';
  btnSizeCat.classList.toggle('active', sizeCat === 'gen');
  lblSizeCat.textContent = (sizeCat === 'gen') ? 'Generative AI' : 'AI';

  // swap data only; colors stay mapped to labels
  sizeChart.data.datasets[0].data = (sizeCat === 'ai') ? sizeAi : sizeGen;
  sizeChart.update();
}


/* ---------- MAP ---------- */
/* ---------- FRANCE-ONLY CHOROPLETH (Zones d’emploi) ---------- */
// Reuse the same toggles you already have:
let mapMode = 'total';   // 'total' | 'share'
let mapCat  = 'ai';      // 'ai' | 'gen'

// Data & drawing handles
let mapData = new Map();     // zone -> { ia, ia_rel, gen, gen_rel, total_offers }
let zonesFC;                 // FeatureCollection
let svg, gFill, path, color; // selection & helpers
let zonePaths;               // selection of all zone <path>s

// --- 1) Build once (no pan/zoom, no mouse handlers) ---
async function loadFrancePolygonMap(){
  // Shapes (TopoJSON)
  const topoResp = await fetch('data/france_zones.topo.json');
  if(!topoResp.ok) throw new Error('Missing file: data/france_zones.topo.json');
  const topo = await topoResp.json();
  const objName = Object.keys(topo.objects)[0];
  if(!objName) throw new Error('No objects in TopoJSON.');
  zonesFC = topojson.feature(topo, topo.objects[objName]);

  // Ensure we have a join key called "zone"
  zonesFC.features.forEach(f=>{
    if(!f.properties.zone){
      f.properties.zone =
        f.properties['Nom Officiel Zone emploi 2020'] ||
        f.properties.ZE2020 ||
        f.properties.nom ||
        f.properties.code_insee || null;
    }
  });
  if(!zonesFC.features[0].properties.zone){
    throw new Error('No usable join key (zone) in TopoJSON properties.');
  }

  // Values (CSV)
  const csvResp = await fetch('data/map_offers_values.csv');
  if(!csvResp.ok) throw new Error('Missing file: data/map_offers_values.csv');
  const csvTxt = await csvResp.text();
  const rows = Papa.parse(csvTxt, {header:true, skipEmptyLines:true}).data;
  rows.forEach(r=>{
    if(!r.zone) return;
    mapData.set(r.zone, {
      ia:+r.ia, ia_rel:+r.ia_rel,
      gen:+r.gen, gen_rel:+r.gen_rel,
      total_offers:+r.total_offers
    });
  });

  // Draw once
  initFranceStatic();
updateLegend();  
}

// Compute 4 quantile thresholds (20/40/60/80%)
function quantileThresholds(values){
  const v = values.filter(Number.isFinite).sort(d3.ascending);
  if (!v.length) return [0.1, 0.5, 1, 2];
  return [0.2, 0.4, 0.6, 0.8].map(p => d3.quantileSorted(v, p));
}

// Compute ~log-spaced thresholds across the positive range
function logThresholds(values){
  const v = values.filter(x => Number.isFinite(x) && x > 0);
  if (!v.length) return [10, 50, 200, 500];
  const min = d3.min(v), max = d3.max(v);
  // 4 internal breaks -> 5 color bands
  const logs = d3.ticks(Math.log10(min), Math.log10(max), 5); // 5 ticks
  return logs.slice(1).map(t => Math.pow(10, t));              // drop lowest tick
}

function quantileThresholds(values, n = 10){
  const v = values.filter(Number.isFinite).sort(d3.ascending);
  if (!v.length) return [];
  const t = [];
  for (let i = 1; i < n; i++) t.push(d3.quantileSorted(v, i / n));
  return t; // length = n-1 → n color classes
}
const REDS_10 = [
  '#fff5f0', // very light
  '#fee6dd',
  '#fdd0c2',
  '#fcb49a',
  '#fc9272',
  '#fb6a4a',
  '#ef3b2c',
  '#cb181d',
  '#a50f15',
  '#67000d'  // darkest
];
  
// Simple number formatting
const fmtInt = d3.format(",.0f");
const fmt1   = d3.format(".1f");
const fmt2   = d3.format(".2f");

function formatMetricValue(x){
  if (!Number.isFinite(x)) return "n/a";
  const isShare = (mapMode === 'share');
  if (isShare){
    // auto-detect fraction vs percent
    if (x <= 1) return `${fmt2(x*100)}%`;
    return `${fmt2(x)}%`;
  } else {
    return fmtInt(x);
  }
}
  
// --- 2) Static rendering (fit to container, no interactions) ---
function initFranceStatic(){
  const container = document.getElementById('mapOffers');
  container.innerHTML = '';

  // Responsive SVG
  const W = 1000, H = 880; // internal coordinate space (kept large for sharpness)
  svg = d3.select('#mapOffers').append('svg')
    .attr('viewBox', `0 0 ${W} ${H}`)
    .attr('preserveAspectRatio', 'xMidYMid meet')
    .style('width',  '100%')
    .style('height', '100%');

  const projection = d3.geoConicConformal().parallels([44,49]).rotate([-3,0]);
  projection.fitSize([W, H], zonesFC);
  path = d3.geoPath(projection);

  updateColorScale();

  // Tooltip (fixed, super light)
  const tip = d3.select('body').append('div')
    .style('position','absolute')
    .style('pointer-events','none')
    .style('background','#fff')
    .style('border','1px solid #ccc')
    .style('border-radius','4px')
    .style('padding','6px 8px')
    .style('box-shadow','0 2px 6px rgba(0,0,0,.15)')
    .style('font','12px sans-serif')
    .style('opacity',0);

  // Draw zones once (white borders)
  gFill = svg.append('g');
  zonePaths = gFill.selectAll('path')
    .data(zonesFC.features)
    .enter()
    .append('path')
      .attr('d', path)
      .attr('fill', d => fillValue(d))
      .attr('stroke', '#d0d0d0')
      .attr('stroke-width', 1)
      // --- Hover highlight + tooltip ---
      .on('mouseenter', function(ev, d){
        d3.select(this).attr('stroke', '#111').attr('stroke-width', 2);
        // bring hovered path to top for crisp border
        this.parentNode.appendChild(this);
        tip.style('opacity', 1);
      })
      .on('mousemove', function(ev, d){
        const zone = d.properties.zone;
        const v = mapData.get(zone);
        const val = v ? currentMetric(v) : NaN;
        tip.html(
          `<b>${zone}</b><br/>` +
          (mapCat==='ai'
            ? `AI: <b>${formatMetricValue(v?.ia)}</b>${mapMode==='share' ? ` (${formatMetricValue(v?.ia_rel)})` : ''}`
            : `GenAI: <b>${formatMetricValue(v?.gen)}</b>${mapMode==='share' ? ` (${formatMetricValue(v?.gen_rel)})` : ''}`
          )
        )
        .style('left',  (ev.pageX + 12) + 'px')
        .style('top',   (ev.pageY + 12) + 'px');
      })
      .on('mouseleave', function(){
        d3.select(this).attr('stroke', '#d0d0d0').attr('stroke-width', 1);
        tip.style('opacity', 0);
      });
}

// --- 3) Color logic with auto thresholds per mode/category ---
function currentMetric(v){
  if(mapCat==='ai')  return mapMode==='total' ? v.ia  : v.ia_rel;
  else               return mapMode==='total' ? v.gen : v.gen_rel;
}
function fillValue(feature){
  const v = mapData.get(feature.properties.zone);
  if(!v) return '#ccc';
  let x = currentMetric(v);
  if (!Number.isFinite(x)) return '#ccc';
  if (mapMode === 'share') x = x * shareScaleFactor; // if we decided to scale to %
  return colorScale(x);
}
function computeThresholds(values, isShare){
  const v = values.filter(Number.isFinite);
  if(!v.length) return isShare ? [0.1, 0.5, 1, 2] : [10, 50, 200, 500];

  const max = d3.max(v);
  if(isShare){
    // auto-detect fraction vs percent
    const isFraction = max <= 1.0;
    const scale = isFraction ? 100 : 1;
    const M = max * scale;
    return d3.ticks(0, M, 5).slice(1); // 4 thresholds
  }else{
    return d3.ticks(0, max, 5).slice(1);
  }
}
let colorScale;      // d3.scaleSequential
let shareScaleFactor = 1; // 1 or 100 (when shares are fractions)
  
function paletteForMode(){
  // d3 sequential interpolators
  if (mapCat === 'ai' && mapMode === 'total') return d3.interpolateReds;
  if (mapCat === 'ai' && mapMode === 'share') return d3.interpolateReds;
  if (mapCat === 'gen' && mapMode === 'total') return d3.interpolateBlues;
  return d3.interpolateBlues; // gen + share
}
  
function updateColorScale(){
  // Raw values for the current view
  const raw = zonesFC.features.map(f => {
    const v = mapData.get(f.properties.zone);
    return v ? currentMetric(v) : NaN;
  }).filter(Number.isFinite);

  // If nothing valid, fall back to a safe scale
  if (!raw.length) {
    shareScaleFactor = 1;
    colorScale = d3.scaleSequential(paletteForMode()).domain([0, 1]).clamp(true);
    return;
  }

  // For Share, auto-detect fractions and scale to % for nicer spread
  const isShare = (mapMode === 'share');
  const maxAbs = d3.max(raw.map(Math.abs)) || 0;
  shareScaleFactor = (isShare && maxAbs <= 1) ? 100 : 1;

  // Build the scaled series used for color domain
  const vals = raw.map(x => x * shareScaleFactor);

  let min = d3.min(vals);
  let max = d3.max(vals);

  // Guard against flat domains (min===max) -> widen a tiny bit
  if (!(isFinite(min) && isFinite(max))) { min = 0; max = 1; }
  if (min === max) {
    const eps = (min === 0) ? 1 : Math.abs(min) * 0.01;
    min = min - eps/2;
    max = max + eps/2;
  }

  // Final sequential linear scale
  colorScale = d3.scaleSequential(paletteForMode())
                 .domain([min, max])   // light→dark from min to max
                 .clamp(true);
}


  
function recolorFrancePolygon(){
  updateColorScale();
  updateLegend();
  zonePaths.attr('fill', d => fillValue(d));
  
}

// --- 4) Keep your existing toggle handlers, just call recolor ---
function toggleMapTotalShare(){
  mapMode = (mapMode==='total') ? 'share' : 'total';
  btnMapMode.classList.toggle('active', mapMode==='share');
  lblMapMode.textContent = mapMode.charAt(0).toUpperCase()+mapMode.slice(1);
  recolorFrancePolygon();
}
function toggleMapAiGen(){
  mapCat = (mapCat==='ai') ? 'gen' : 'ai';
  btnMapCat.classList.toggle('active', mapCat==='gen');
  lblMapCat.textContent = (mapCat==='gen') ? 'Generative AI' : 'AI';
  recolorFrancePolygon();
}


function legendTickFormat(x){
  const isShare = (mapMode === 'share');
  if (isShare && shareScaleFactor === 100) return d3.format('.1f')(x) + '%';
  if (isShare) return d3.format('.3f')(x); // shares already in %
  if (x >= 1000) return d3.format('~s')(x); // 1.2k style
  return d3.format(',')(x);
}

// Build once, then update on toggles
let legendSvg, legendScale, legendAxis, legendGradient;
function initLegend(){
  const W = Math.min(document.getElementById('mapLegend').clientWidth || 600, 1100);
  const H = 48, PAD = {l:14, r:14, t:8, b:20};

  legendSvg = d3.select('#mapLegend')
    .append('svg')
    .attr('width', W)
    .attr('height', H);

  const defs = legendSvg.append('defs');
  legendGradient = defs.append('linearGradient')
    .attr('id', 'legendGradient')
    .attr('x1', '0%').attr('x2', '100%')
    .attr('y1', '0%').attr('y2', '0%');

  // gradient rect
  legendSvg.append('rect')
    .attr('x', PAD.l)
    .attr('y', PAD.t)
    .attr('height', 12)
    .attr('rx', 2)
    .attr('width', W - PAD.l - PAD.r)
    .attr('fill', 'url(#legendGradient)');

  // axis
  legendScale = d3.scaleLinear().range([PAD.l, W - PAD.r]);
  legendAxis  = d3.axisBottom(legendScale).ticks(6).tickFormat(legendTickFormat);

  legendSvg.append('g')
    .attr('class', 'legendAxis')
    .attr('transform', `translate(0, ${PAD.t + 12})`)
    .call(legendAxis);
}

// Call after every recolor to refresh gradient + ticks
function updateLegend(){
  if (!legendSvg) initLegend();

  const [d0, d1] = colorScale.domain();        // min/max of current view
  legendScale.domain([d0, d1]);
  legendSvg.select('.legendAxis').call(
    d3.axisBottom(legendScale).ticks(6).tickFormat(legendTickFormat)
  );

  // rebuild gradient stops from the current interpolator
  const interp = paletteForMode();
  const stops = d3.range(0, 1.0001, 0.1); // 11 stops for smooth ramp
  legendGradient.selectAll('stop').remove();
  legendGradient.selectAll('stop')
    .data(stops)
    .enter().append('stop')
      .attr('offset', d => (d * 100) + '%')
      .attr('stop-color', d => interp(d));
}


  
/* ---------- MÉTIERS AREA CHART ---------- */
let metierChart,metierMode='ia';
function buildMetier(){
  metierChart=new Chart(document.getElementById('metierChart'),{
    type:'line',
    data:{labels:metierDates,datasets:metierIA},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{y:{stacked:true}},
      elements:{line:{fill:true,tension:.3}}
    }
  });
}

// Hardened Métiers CSV loader
async function loadMetier(file, targetArr, dateArr) {
  const txt = await fetchCsv(file);
  const d = Papa.parse(txt, { header: true, skipEmptyLines: true }).data;
  if (!d.length) {
    console.warn('Metier CSV is empty:', file);
    return;
  }

  // Fill date labels once
  if (dateArr.length === 0) d.forEach(x => dateArr.push(x.date));

  // All columns except 'date' become series
  const keys = Object.keys(d[0]).filter(k => k !== 'date');
  if (!keys.length) {
    console.warn('Metier CSV has no columns (except date):', file);
    return;
  }

  keys.forEach((k, i) => {
    const fill = metierPalette[i % metierPalette.length]; // e.g. 'rgba(...,1.0)'
    // soften fill if it's rgba(...,1.0)
    const bg = fill.replace(/1\.0\)$/, '0.35)');

    targetArr.push({
      label: k,
      data: d.map(x => toNum(x[k])),   // numeric
      borderColor: fill,               // stroke
      backgroundColor: bg,             // translucent fill
      fill: true,
      stack: 's',
      pointRadius: 0
    });
  });

  console.log('Loaded métiers:', file, 'series:', keys.length, 'points:', dateArr.length);
}

  
function toggleMetier(){
  metierMode = (metierMode==='ia') ? 'data' : 'ia';
  btnMetierCat.classList.toggle('active',metierMode==='data');
  lblMetierCat.textContent = (metierMode==='data') ? 'Data/IA' : 'IA';
  metierChart.data.labels   = (metierMode==='ia') ? metierDates    : metierDatesData;
  metierChart.data.datasets = (metierMode==='ia') ? metierIA       : metierData;
  metierChart.update();
}

/* ---------- SKILLS (LINES, not stacked) ---------- */
let skillsChart, skillsType='ml_library';
function buildSkills(){
  skillsChart = new Chart(document.getElementById('skillsChart'),{
    type:'line',
    data:{ labels: skillsDates[skillsType], datasets: skillsSets[skillsType] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:'nearest', intersect:false},
      scales:{ y:{ stacked:false } },
      elements:{ line:{ fill:false, tension:.25 } },
      plugins:{ legend:{ position:'bottom' } }
    }
  });
}
function setSkillsType(t){
  skillsType = t;
  btnSkillsLibraries.classList.toggle('active', t==='ml_library');
  btnSkillsMethods .classList.toggle('active', t==='method_skills');
  btnSkillsBroad   .classList.toggle('active', t==='broad_skills');
  skillsChart.data.labels   = skillsDates[t];
  skillsChart.data.datasets = skillsSets[t];
  skillsChart.update();
}
async function loadSkills(file, key){
  const d = Papa.parse(await fetchCsv(file), {header:true, skipEmptyLines:true}).data;
  if(!d.length) return;
  skillsDates[key] = d.map(x=>x.date);
  const keys = Object.keys(d[0]).filter(k=>k!=='date');
  skillsSets[key] = keys.map((k,i)=>({
    label: k,
    data: d.map(x=>+x[k]),
    borderColor: pastel(i),
    pointRadius: 0,
    fill: false
  }));
}

  if ('scrollRestoration' in history) {
  history.scrollRestoration = 'manual';
}
  
/* ---------- LOAD EVERYTHING ---------- */
window.onload=async()=>{
  showPage('accueil');
  await loadHome();

  try{
    /* offers */
    parseCsv(await fetchCsv('data/offers_total.csv')).forEach(r=>{
      dateLabels.push(monthLabel(+r[0])); totalGen.push(+r[1]); totalAI.push(+r[2]); totalCV.push(+r[3]);   totalNLP.push(+r[4]);
    });
    parseCsv(await fetchCsv('data/offers_share.csv')).forEach(r=>{
      shareGen.push(+r[1]); shareAI.push(+r[2]); shareCV.push(+r[3]);shareNLP.push(+r[4]);
    });
    buildOffers();

    /* sectors (robust loader) */
    await loadTwoSectors('data/two_sectors_total_gen.csv',    true,  indTotGen, servTotGen);
    await loadTwoSectors('data/two_sectors_total_nongen.csv', false, indTotNon, servTotNon);
    await loadTwoSectors('data/two_sectors_share_gen.csv',    false, indShGen,  servShGen);
    await loadTwoSectors('data/two_sectors_share_nongen.csv', false, indShNon,  servShNon);
    buildSectors();

    /* sector evolution */
    const loadEvol=async(file,targetArr,dateArr)=>{
      const d=Papa.parse(await fetchCsv(file),{header:true,skipEmptyLines:true}).data;
      if(d.length===0) return;
      if(dateArr.length===0) d.forEach(x=>dateArr.push(x.date));
      Object.keys(d[0]).filter(k=>k!=='date').forEach((k,i)=>{
        targetArr.push({label:k,data:d.map(x=>+x[k]),borderColor:pastel(i),backgroundColor:pastel(i),fill:true,stack:'s'});
      });
    };
    await loadEvol('data/sector_evol_ia.csv'   ,evolAI ,evolDates);
    await loadEvol('data/sector_evol_iagen.csv',evolGen,evolDatesGen);
    await loadEvol('data/sector_evol_all.csv'  ,evolAll,evolDates);
    buildEvol();

    /* size */
    parseCsv(await fetchCsv('data/distrib_size.csv')).forEach(r=>{
      sizeLabels.push(r[0]); sizeAi.push(+r[1]); sizeGen.push(+r[2]);
    });
    buildSize();

/* métiers */
await loadMetier('data/metier_area_ia.csv'  ,metierIA  ,metierDates);
await loadMetier('data/metier_area_data.csv',metierData,metierDatesData);
buildMetier();

/* skills */
await loadSkills('data/evolution_ml_library_skills.csv','ml_library');
await loadSkills('data/evolution_method_skills.csv','method_skills');
await loadSkills('data/evolution_broad_skills.csv','broad_skills');
buildSkills();

/* map (last, isolated) */
try {
  await loadFrancePolygonMap();
} catch (e) {
  console.error('Map failed:', e);
  const m = document.getElementById('mapOffers');
  if (m) m.innerHTML = '<div style="text-align:center;padding:20px;color:#a00">Map data missing or invalid.</div>';
}

  } catch(err) {
    console.error('Error during dashboard load:', err);
  }


// Scrollspy for dashboards sections (works even with inline onclicks)
const spyTargets = ["totalOffersSection","sectorsSection","sizeSection","metierSection","skillsSection","mapOffersSection"]
  .map(id => document.getElementById(id));
const spyButtons = [...document.querySelectorAll('.sub-nav button')];

const spy = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(!e.isIntersecting) return;
    const id = e.target.id;
    spyButtons.forEach(b=>{
      const target = b.getAttribute('onclick') || '';
      const isActive = target.includes(id);
      b.classList.toggle('active', isActive);
    });
  });
},{rootMargin:"-40% 0px -50% 0px", threshold:.01});
spyTargets.forEach(el=> el && spy.observe(el));

// Reveal sections/tiles as they enter the viewport
document.querySelectorAll('.chart-section, .key-figure-card').forEach(el=>{
  el.classList.add('reveal');
});
const revealer = new IntersectionObserver(es=>{
  es.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('is-in'); revealer.unobserve(e.target); } });
},{threshold:.15});
document.querySelectorAll('.reveal').forEach(el=> revealer.observe(el));  
  
};

</script>
</body>
</html>











































