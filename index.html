<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI-tracker</title>
  <!-- Chart.js (for first two dashboards) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet (for the map) -->
  <link 
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-1yXY5T2Ec8AIWoWTRfVdfo4X0O6SC1dLL4f72gDxGJc="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-Dtomj3yQXr3R9TxSNezAkn5JZf2fcs3tiCJ7RDU4o8Q="
    crossorigin=""
  ></script>

  <style>
    /* Global styles (same as before) */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: white;
    }
    header {
      width: 100%;
      background-color: #f2f2f2;
      padding: 10px;
    }
    .header-top {
      display: flex;
      align-items: center;
    }
    .left-block, .center-block, .right-block {
      flex: 1;
      min-height: 50px;
    }
    .left-block {
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }
    .logo {
      height: 80px;
      margin-left: 10px;
    }
    .center-block {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .center-block h1 {
      margin: 0;
      font-size: 1.8em;
    }
    .right-block {}
    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }
    nav button {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    nav button:hover {
      background-color: #eee;
    }

    .page {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }

    /* Accueil Page (unchanged) */
    #accueil h2 {
      text-align: center;
      margin-top: 30px;
    }
    .explanation {
      max-width: 800px; margin: 30px auto; text-align: center; font-size: 1em; line-height: 1.4em;
    }
    .additional-figures {
      max-width: 1000px; margin: 40px auto;
    }
    .additional-figures h3 {
      text-align: center; margin-bottom: 20px;
    }
    .figures-row {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 40px;
    }
    .key-figure-card {
      border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 20px; width: 200px; text-align: center; background-color: #fff;
    }

    /* Dashboards Page (unchanged except new 3rd dash) */
    #dashboards {
      margin: 0 auto;
      max-width: 1000px;
    }
    #dashboards h2 {
      margin-bottom: 10px; text-align: center;
    }
    .sub-nav {
      text-align: center; margin-bottom: 20px;
    }
    .sub-nav button {
      margin: 5px; background-color: #fff; border: 1px solid #ccc; cursor: pointer; border-radius: 4px;
    }
    .chart-section {
      margin-bottom: 40px;
    }
    .chart-controls {
      margin: 10px 0; text-align: center;
    }
    .chart-container {
      width: 100%; max-width: 800px; margin: 0 auto;
    }
    #adoptersSection .chart-container {
      max-width: 400px;
    }

    /* Projects Page (unchanged) */
    #projects h2 {
      text-align: center; margin-bottom: 40px;
    }
    #projects section {
      max-width: 800px; margin: 0 auto 30px auto;
    }
    #projects section h3 {
      border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;
    }

    /* Map styling for the new 3rd dashboard */
    #mapOffersSection .map-container {
      width: 600px;
      height: 600px;
      margin: 0 auto; /* center it */
    }
  </style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="left-block">
      <img src="logo.png" alt="AI-tracker logo" class="logo" />
    </div>
    <div class="center-block">
      <h1>AI-tracker</h1>
    </div>
    <div class="right-block"></div>
  </div>
  <nav>
    <button onclick="showPage('accueil')">Accueil</button>
    <button onclick="showPage('dashboards')">Dashboards</button>
    <button onclick="showPage('projects')">Projects</button>
  </nav>
</header>

<!-- ACCUEIL PAGE -->
<div id="accueil" class="page active">
  <h2>Welcome to the AI-tracker!</h2>
  <p style="text-align:center;">
    Here you can find insights into the evolution of AI adoption by French firms, based on their recruitment data.
  </p>
  
  <div class="explanation">
    This tracker is built using machine learning models on the JOCAS database, edited by the 
    French Ministry of Labor's DARES. By automatically detecting AI-related job offers, 
    the AI-tracker monitors the growing adoption of this technology within the French economy.
  </div>

  <!-- Additional Figures (mock) -->
  <div class="additional-figures">
    <!-- AI Figures -->
    <h3>Additional Key Figures - AI</h3>
    <div class="figures-row">
      <div class="key-figure-card">
        <h4>Firms Having Recruited for AI (Total)</h4>
        <p>8,500 (mock)</p>
      </div>
      <div class="key-figure-card">
        <h4>New Recruiters Last Quarter</h4>
        <p>400 (mock)</p>
        <p><small>+5% vs. previous quarter (mock)</small></p>
      </div>
      <div class="key-figure-card">
        <h4>Number of AI Offers (Total)</h4>
        <p>45,000 (mock)</p>
      </div>
      <div class="key-figure-card">
        <h4>AI Offers Last Quarter</h4>
        <p>6,000 (mock)</p>
        <p><small>+10% vs. previous quarter (mock)</small></p>
      </div>
    </div>

    <!-- Generative AI Figures -->
    <h3>Additional Key Figures - Generative AI</h3>
    <div class="figures-row">
      <div class="key-figure-card">
        <h4>Firms Having Recruited for Generative AI (Total)</h4>
        <p>2,000 (mock)</p>
      </div>
      <div class="key-figure-card">
        <h4>New Recruiters Last Quarter</h4>
        <p>150 (mock)</p>
        <p><small>+8% vs. previous quarter (mock)</small></p>
      </div>
      <div class="key-figure-card">
        <h4>Number of Generative AI Offers (Total)</h4>
        <p>20,000 (mock)</p>
      </div>
      <div class="key-figure-card">
        <h4>Generative AI Offers Last Quarter</h4>
        <p>2,000 (mock)</p>
        <p><small>+12% vs. previous quarter (mock)</small></p>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARDS PAGE -->
<div id="dashboards" class="page">
  <h2>Dashboards</h2>
  <div class="sub-nav">
    <button onclick="scrollToSection('totalOffersSection')">Total Offers</button>
    <button onclick="scrollToSection('sectorsSection')">Sectors</button>
    <button onclick="scrollToSection('mapOffersSection')">Map</button> <!-- NEW LINK to map -->
    <button onclick="scrollToSection('adoptersSection')">Adopters</button>
  </div>

  <!-- 1) Evolution of AI offers (unchanged) -->
  <div id="totalOffersSection" class="chart-section">
    <h3>Evolution of AI-Related Job Offers</h3>
    <div class="chart-controls">
      <button onclick="toggleTotalShare('offersChart')">Toggle Total / Share</button><br/><br/>
    </div>
    <div class="chart-container">
      <canvas id="offersChart"></canvas>
    </div>
  </div>

  <!-- 2) Sectors (unchanged) -->
  <div id="sectorsSection" class="chart-section">
    <h3>Firms Adopting AI by Sector</h3>
    <div class="chart-controls">
      <button onclick="toggleSectorsTotalShare()">Toggle Total / Share</button>
      <button onclick="toggleSectorsGenNonGen()">Toggle GenAI / Non-GenAI</button>
    </div>
    <div class="chart-container">
      <canvas id="sectorsChart"></canvas>
    </div>
  </div>

  <!-- 3) NEW: Map Offers Dashboard -->
  <div id="mapOffersSection" class="chart-section">
    <h3>Map of French Zones dâ€™Emplois</h3>
    <div class="chart-controls">
      <button onclick="toggleMapTotalShare()">Toggle Total / Share</button>
      <button onclick="toggleMapAiGen()">Toggle AI / Generative AI</button>
    </div>
    <!-- The Leaflet map container -->
    <div class="map-container" id="mapOffers"></div>
  </div>

  <!-- 4) Composition of AI adopters (unchanged) -->
  <div id="adoptersSection" class="chart-section">
    <h3>Composition of AI Adopters</h3>
    <div class="chart-container">
      <canvas id="adoptersChart"></canvas>
    </div>
  </div>
</div>

<!-- PROJECTS PAGE -->
<div id="projects" class="page">
  <h2>Projects</h2>
  <section class="authors">
    <h3>Authors</h3>
    <p>This AI-tracker is developed by three economists:</p>
    <ul>
      <li>Paul Delbouve</li>
      <li>Philippe Aghion</li>
      <li>Antonin Bergeaud</li>
    </ul>
  </section>
  <section class="papers">
    <h3>Academic Papers</h3>
    <p>
      Here you will find academic papers linked with this website and ongoing research projects related to AI adoption.
      <br /><br />
      <strong>Paper 1:</strong> <em>Title and Link (mock)</em><br />
      <strong>Paper 2:</strong> <em>Title and Link (mock)</em>
    </p>
  </section>
</div>

<script>
  /****************************************************
   * Basic Page Navigation
   ****************************************************/
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
  }
  function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (!section) return;
    showPage('dashboards');
    section.scrollIntoView({ behavior: 'smooth' });
  }

  /****************************************************
   * CSV fetch & parse
   ****************************************************/
  async function fetchCsv(url) {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`Failed to fetch ${url}`);
    return await resp.text();
  }
  function parseCsv(csvText) {
    const lines = csvText.trim().split('\n');
    const rows = [];
    for (let i=1; i<lines.length; i++){
      rows.push(lines[i].split(','));
    }
    return rows;
  }

  /****************************************************
   * 1) FIRST CHART (offers) - unchanged
   ****************************************************/
  let offersChart, offersMode = 'total';
  let dateLabels = [], totalDataOffersGen = [], totalDataOffersGeneral = [], totalDataOffersCV = [];
  let shareDataOffersGen = [], shareDataOffersGeneral = [], shareDataOffersCV = [];

  function monthLabel(i){
    // i=0 => "2019-01", etc
    const baseYear=2019;
    const year = baseYear + Math.floor(i/12);
    const month= (i%12)+1;
    return `${year}-${String(month).padStart(2,"0")}`;
  }

  function createOffersChart(){
    const ctx = document.getElementById('offersChart').getContext('2d');
    offersChart = new Chart(ctx,{
      type:'bar',
      data:{
        labels: dateLabels,
        datasets:[
          {
            label:'IA GÃ©nÃ©rative',
            data: totalDataOffersGen,
            backgroundColor:'rgba(255, 99, 132, 0.7)'
          },
          {
            label:'IA GÃ©nÃ©rale',
            data: totalDataOffersGeneral,
            backgroundColor:'rgba(75, 192,192,0.7)'
          },
          {
            label:'Computer Vision',
            data: totalDataOffersCV,
            backgroundColor:'rgba(54,162,235,0.7)'
          }
        ]
      },
      options:{
        responsive:true,
        scales:{
          x:{ stacked:true},
          y:{ stacked:true}
        }
      }
    });
  }
  function toggleTotalShare(chartName){
    if(chartName==='offersChart'){
      offersMode= (offersMode==='total')?'share':'total';
      if(offersMode==='total'){
        offersChart.data.datasets[0].data=totalDataOffersGen;
        offersChart.data.datasets[1].data=totalDataOffersGeneral;
        offersChart.data.datasets[2].data=totalDataOffersCV;
      }else{
        offersChart.data.datasets[0].data=shareDataOffersGen;
        offersChart.data.datasets[1].data=shareDataOffersGeneral;
        offersChart.data.datasets[2].data=shareDataOffersCV;
      }
      offersChart.update();
    }
  }

  /****************************************************
   * 2) SECOND CHART (Sectors) - unchanged
   ****************************************************/
  let sectorsChart;
  let sectorsMode='total'; // or 'share'
  let sectorsAIType='genAI'; // or 'nonGenAI'
  let sectorsLabels=[];

  let industryTotalGen=[],serviceTotalGen=[];
  let industryTotalNonGen=[],serviceTotalNonGen=[];
  let industryShareGen=[],serviceShareGen=[];
  let industryShareNonGen=[],serviceShareNonGen=[];

  function quarterLabel(i){
    // interpret i as Q
    const baseYear=2019;
    const year= baseYear + Math.floor(i/4);
    const q=(i%4)+1;
    return `Q${q} ${year}`;
  }
  function createSectorsChart(){
    const ctx = document.getElementById('sectorsChart').getContext('2d');
    sectorsChart= new Chart(ctx,{
      type:'bar',
      data:{
        labels: sectorsLabels,
        datasets:[
          {
            label:'Industrie',
            data:[],
            backgroundColor:'rgba(153,102,255,0.7)'
          },
          {
            label:'Services',
            data:[],
            backgroundColor:'rgba(255,205,86,0.7)'
          }
        ]
      },
      options:{responsive:true}
    });
    updateSectorsChart();
  }
  function updateSectorsChart(){
    let indData, servData;
    if(sectorsMode==='total' && sectorsAIType==='genAI'){
      indData=industryTotalGen; servData=serviceTotalGen;
    }
    else if(sectorsMode==='total' && sectorsAIType==='nonGenAI'){
      indData=industryTotalNonGen; servData=serviceTotalNonGen;
    }
    else if(sectorsMode==='share' && sectorsAIType==='genAI'){
      indData=industryShareGen; servData=serviceShareGen;
    }
    else{ // share+nonGenAI
      indData=industryShareNonGen; servData=serviceShareNonGen;
    }
    sectorsChart.data.datasets[0].data=indData;
    sectorsChart.data.datasets[1].data=servData;
    sectorsChart.update();
  }
  function toggleSectorsTotalShare(){
    sectorsMode=(sectorsMode==='total')?'share':'total';
    updateSectorsChart();
  }
  function toggleSectorsGenNonGen(){
    sectorsAIType=(sectorsAIType==='genAI')?'nonGenAI':'genAI';
    updateSectorsChart();
  }

  /****************************************************
   * 3) NEW: MAP of OFFERS
   *    Data from: map_offers.csv with columns:
   *    Nom Officiel Zone emploi 2020, geometry, ia, ia_rel,
   *    ia gÃ©nÃ©rative, ia gÃ©nÃ©rative_rel, total_offers
   ****************************************************/
  let mapOffers; // the Leaflet map instance
  let mapGeoLayers=[]; // we'll store layers for each zone
  let mapData=[]; // store the parsed rows

  // Toggling
  let mapOffersMode='total'; // or 'share'
  let mapOffersAI='ai'; // or 'gen' (meaning generative)

  function toggleMapTotalShare(){
    mapOffersMode = (mapOffersMode==='total')?'share':'total';
    recolorMap();
  }
  function toggleMapAiGen(){
    mapOffersAI = (mapOffersAI==='ai')?'gen':'ai';
    recolorMap();
  }

  // Recolor polygons based on current mode
  function recolorMap(){
    // pick which CSV column we use
    // if (mapOffersAI='ai' & mapOffersMode='total') => 'ia'
    // if (mapOffersAI='ai' & mapOffersMode='share') => 'ia_rel'
    // if (mapOffersAI='gen' & mapOffersMode='total') => 'ia gÃ©nÃ©rative'
    // if (mapOffersAI='gen' & mapOffersMode='share') => 'ia gÃ©nÃ©rative_rel'
    let colName;
    if(mapOffersAI==='ai' && mapOffersMode==='total'){
      colName='ia';
    } else if(mapOffersAI==='ai' && mapOffersMode==='share'){
      colName='ia_rel';
    } else if(mapOffersAI==='gen' && mapOffersMode==='total'){
      colName='ia gÃ©nÃ©rative';
    } else {
      colName='ia gÃ©nÃ©rative_rel';
    }

    // loop over each polygon layer, find the data row's chosen column
    // set the style color accordingly
    mapGeoLayers.forEach((layerObj)=>{
      // each layerObj = {layer, rowData}
      const val= parseFloat(layerObj.rowData[colName]);
      const color = pickColor(val);
      layerObj.layer.setStyle({ fillColor: color });
    });
  }

  // A simple color scale function
  function pickColor(val){
    // e.g. if val is bigger => darker
    // adapt as needed
    if(isNaN(val)) return '#cccccc';
    if(val<10) return '#fee5d9';
    if(val<50) return '#fcae91';
    if(val<200) return '#fb6a4a';
    if(val<500) return '#de2d26';
    return '#a50f15';
  }

  function createMapOffers(){
    // Create the Leaflet map
    mapOffers= L.map('mapOffers').setView([46.8, 2.0],6); // center of France

    // add a basemap layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap'
    }).addTo(mapOffers);

    // add polygons from mapData
    mapData.forEach(row=>{
      // row= {
      //   zoneName, geometry, ia, ia_rel, ia gÃ©nÃ©rative, ia gÃ©nÃ©rative_rel, total_offers
      // }
      // geometry is a GeoJSON polygon
      try{
        const geo = JSON.parse(row.geometry); // parse from CSV string
        const layer = L.geoJSON(geo,{
          style:{
            fillColor:'#cccccc',
            color:'#999999',
            weight:1,
            fillOpacity:0.6
          }
        }).addTo(mapOffers);

        // store a reference so we can recolor
        mapGeoLayers.push({
          layer: layer,
          rowData: row
        });

        // optionally bind a popup
        layer.bindPopup(`${row['Nom Officiel Zone emploi 2020']}<br/>
          IA: ${row.ia}<br/> IA_rel: ${row.ia_rel}<br/>
          GenAI: ${row['ia gÃ©nÃ©rative']}<br/>
          GenAI_rel: ${row['ia gÃ©nÃ©rative_rel']}`);

      }catch(e){
        console.error('Invalid geometry for row:',row['Nom Officiel Zone emploi 2020'], e);
      }
    });

    // color them initially
    recolorMap();
  }

  /****************************************************
   * 4) ZONES CHART (mock)
   ****************************************************/
  let zonesChart;
  function createZonesChart() {
    const ctx=document.getElementById('zonesChart').getContext('2d');
    zonesChart= new Chart(ctx,{
      type:'bar',
      data:{
        labels:['Paris','Lyon','Marseille'],
        datasets:[{
          label:'IA Offers',
          data:[500,300,200],
          backgroundColor:'rgba(255,159,64,0.7)'
        }]
      },
      options:{
        indexAxis:'y',
        responsive:true
      }
    });
  }

  /****************************************************
   * 5) ADOPTERS CHART (mock)
   ****************************************************/
  let adoptersChart;
  function createAdoptersChart(){
    const ctx=document.getElementById('adoptersChart').getContext('2d');
    adoptersChart=new Chart(ctx,{
      type:'pie',
      data:{
        labels:['PME','ETI','GE'],
        datasets:[{
          label:'Composition of AI Adopters',
          data:[50,30,20],
          backgroundColor:[
            'rgba(54,162,235,0.7)',
            'rgba(255,206,86,0.7)',
            'rgba(75,192,192,0.7)'
          ]
        }]
      },
      options:{responsive:true}
    });
  }

  /****************************************************
   * On window load: fetch CSVs & build dashboards
   ****************************************************/
  window.onload=async function(){
    try{
      /***** 1) FIRST CHART: offers_total.csv & offers_share.csv *****/
      {
        // e.g. columns: index,ia gÃ©nÃ©rative,ia gÃ©nÃ©rale,cv
        const totalCsv=await fetchCsv('data/offers_total.csv');
        const totalRows=parseCsv(totalCsv);
        for(let row of totalRows){
          const i=parseInt(row[0]);
          dateLabels.push(monthLabel(i));
          totalDataOffersGen.push(parseFloat(row[1]));
          totalDataOffersGeneral.push(parseFloat(row[2]));
          totalDataOffersCV.push(parseFloat(row[3]));
        }

        // offers_share.csv
        const shareCsv=await fetchCsv('data/offers_share.csv');
        const shareRows=parseCsv(shareCsv);
        for(let row of shareRows){
          shareDataOffersGen.push(parseFloat(row[1]));
          shareDataOffersGeneral.push(parseFloat(row[2]));
          shareDataOffersCV.push(parseFloat(row[3]));
        }
      }

      /***** 2) SECOND CHART: 4 CSV for total/share + genAI/nonGenAI *****/
      {
        // two_sectors_total_gen.csv => index,Industrie,Services
        const totalGenText=await fetchCsv('data/two_sectors_total_gen.csv');
        const totalGenRows=parseCsv(totalGenText);
        for(let row of totalGenRows){
          const idx=parseInt(row[0]);
          if(sectorsLabels.length<=idx){
            sectorsLabels.push(quarterLabel(idx));
          }
          industryTotalGen.push(parseFloat(row[1]));
          serviceTotalGen.push(parseFloat(row[2]));
        }

        // two_sectors_total_nongen.csv
        const totalNonGenText=await fetchCsv('data/two_sectors_total_nongen.csv');
        const totalNonGenRows=parseCsv(totalNonGenText);
        for(let row of totalNonGenRows){
          industryTotalNonGen.push(parseFloat(row[1]));
          serviceTotalNonGen.push(parseFloat(row[2]));
        }

        // two_sectors_share_gen.csv
        const shareGenText=await fetchCsv('data/two_sectors_share_gen.csv');
        const shareGenRows=parseCsv(shareGenText);
        for(let row of shareGenRows){
          industryShareGen.push(parseFloat(row[1]));
          serviceShareGen.push(parseFloat(row[2]));
        }

        // two_sectors_share_nongen.csv
        const shareNonGenText=await fetchCsv('data/two_sectors_share_nongen.csv');
        const shareNonGenRows=parseCsv(shareNonGenText);
        for(let row of shareNonGenRows){
          industryShareNonGen.push(parseFloat(row[1]));
          serviceShareNonGen.push(parseFloat(row[2]));
        }
      }

      /***** 3) MAP: load "map_offers.csv" *****/
      {
        // columns: Nom Officiel Zone emploi 2020, geometry, ia, ia_rel,
        //          ia gÃ©nÃ©rative, ia gÃ©nÃ©rative_rel, total_offers
        const mapCsv=await fetchCsv('data/map_offers.csv');
        const mapRows=parseCsv(mapCsv); 
        // We'll store each row in an object with these keys
        for(let row of mapRows){
          // row e.g: 
          // [ "Saclay", "{\"type\":\"Polygon\"...}", "7179","0.0083","281","0.00024","286423" ]
          // We'll build a structured object
          let obj={
            'Nom Officiel Zone emploi 2020': row[0],
            geometry: row[1],
            ia: row[2],
            ia_rel: row[3],
            'ia gÃ©nÃ©rative': row[4],
            'ia gÃ©nÃ©rative_rel': row[5],
            total_offers: row[6]
          };
          // store in mapData array
          mapData.push(obj);
        }
      }

      // Now create the charts
      createOffersChart();    // first chart
      createSectorsChart();   // second chart
      createZonesChart();     // mock
      createAdoptersChart();  // mock
      createMapOffers();      // the new map-based third dashboard
    }catch(err){
      console.error("Error loading data:",err);
    }
  };
</script>

</body>
</html>
