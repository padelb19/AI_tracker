<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The French AI‑tracker</title>

  <!-- Description / SEO -->
  <meta name="description" content="Real‑time dashboard tracking AI diffusion in the French economy using JOCAS job postings." />
  <link rel="icon" href="favicon.ico" />
  <meta property="og:title" content="The French AI‑tracker" />
  <meta property="og:description" content="Tracking AI diffusion across sectors, skills, and regions in France." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="social-card.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Libraries (deferred) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>

  <style>
  /* =========================
     DESIGN SYSTEM (Navy theme)
     ========================= */
  :root{
    /* brand */
    --brand-900:#0b1f3a;
    --brand-800:#132a4a;
    --brand-700:#1c3a63;
    --brand-600:#274b7a;
    --brand-500:#2f5f9a;
    --brand-300:#7ea7d8;
    --brand-100:#e9f0f8;

    /* neutrals */
    --ink-900:#0f172a;
    --ink-700:#1f2937;
    --ink-600:#334155;
    --ink-500:#475569;
    --ink-400:#94a3b8;
    --ink-300:#cbd5e1;

    /* surfaces */
    --card-bg:#ffffff;
    --card-border:#e5e7eb;
    --shadow: 0 10px 25px rgba(2,12,27,.08);
    --radius: 14px;
  }

  html, body {
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--ink-900);
    background:
      radial-gradient(1200px 800px at 10% -10%, rgba(47,95,154,.08), transparent 50%),
      radial-gradient(1000px 600px at 110% 10%, rgba(19,42,74,.06), transparent 45%),
      #ffffff;
  }
  *{ box-sizing:border-box }

  /* =========================
     HEADER + NAV
     ========================= */
  header{
    background: linear-gradient(135deg, var(--brand-900), var(--brand-700));
    color:#fff; padding:20px 18px; position:sticky; top:0; z-index:10;
    box-shadow: 0 2px 18px rgba(0,0,0,.08);
  }
  .header-top{ display:flex; align-items:center; gap:16px; }
  .left-block,.center-block,.right-block{ flex:1; min-height:50px }
  .left-block{ display:flex; align-items:center }
  .logo{ height:72px; width:auto; margin-left:6px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.15)); }
  .center-block{ display:flex; justify-content:center; align-items:center; pointer-events:none }
  .center-block h1{ margin:0; font-size:1.9rem; font-weight:700; letter-spacing:.2px }

  nav[aria-label="Primary"]{
    display:flex; justify-content:center; gap:12px; margin:12px 0 0; flex-wrap:wrap;
  }
  nav[aria-label="Primary"] button{
    padding:10px 16px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
    background: rgba(255,255,255,.10); color:#fff; cursor:pointer;
    backdrop-filter: saturate(140%) blur(4px);
    transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
  }
  nav[aria-label="Primary"] button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.18); box-shadow: 0 8px 16px rgba(0,0,0,.15); }

  /* Accessibility */
  :focus-visible{ outline:2px solid var(--brand-500); outline-offset:2px; }
  @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation-duration:0.001ms !important; animation-iteration-count:1 !important; } }

  /* =========================
     LAYOUT (pages/sections)
     ========================= */
  .page{ display:none; padding:20px }
  .page[hidden]{ display:none !important }
  .page.active{ display:block }

  /* “Carded” sections */
  .chart-section, .additional-figures{
    background: var(--card-bg);
    border:1px solid var(--card-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:24px; margin: 28px auto; max-width:1100px;
    transition: box-shadow .2s ease, border-color .2s ease;
  }
  .chart-section:hover{ box-shadow: 0 16px 34px rgba(2,12,27,.12) }

  /* Hero / intro */
  #accueil .welcome-title{ text-align:center; margin-top:30px; line-height:1.3em; }
  #accueil .welcome-title .subtitle{ display:block; margin-top:6px; font-size:1rem; font-weight:400; color:var(--ink-600); }
  .explanation{ max-width:900px; margin:24px auto 8px; line-height:1.55em; text-align:center; color:var(--ink-700); }

  /* Headings */
  #dashboards h2, .figures-title{ text-align:center; margin: 26px 0 6px; font-size:1.9rem; font-weight:700; color:var(--brand-900); }
  .chart-section h3{ margin:0 0 10px; font-size:1.25rem; font-weight:700; color:var(--brand-800); }
  .dashboard-intro{ max-width:850px; margin:0 auto 18px; text-align:center; font-size:.98rem; color:var(--ink-600); }

  /* Grid for key figures */
  .additional-figures{ max-width:1100px; }
  .figures-row{ display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-bottom:18px }
  .key-figure-card{ border:1px solid var(--card-border); border-radius: var(--radius); box-shadow: var(--shadow); padding:18px 18px 16px; width: 240px; text-align:center; background:#fff; }
  .key-figure-card h4{ color:var(--brand-700); margin:0 0 6px }
  .key-figure-card p:first-of-type{ font-size:2rem; font-weight:700; color:var(--brand-900); margin: 6px 0 }
  .key-figure-card small{ color:var(--ink-600) }
  .key-figure-card.clickable{ cursor:pointer; transition: transform .15s ease, box-shadow .15s ease }
  .key-figure-card.clickable:hover{ transform: translateY(-3px); box-shadow: 0 14px 28px rgba(19,42,74,.12); }

  /* Sub-navigation inside Dashboards */
  .sub-nav{ text-align:center; margin-bottom:20px; }
  .sub-nav button{ margin:6px; background:#f3f6fb; color:var(--brand-700); border:1px solid #dbe3ef; border-radius:999px; cursor:pointer; padding:8px 14px; font-weight:600; transition: background .2s ease, transform .15s ease, box-shadow .2s ease; }
  .sub-nav button:hover{ transform: translateY(-1px); background:#e9f0f8; box-shadow:0 8px 16px rgba(19,42,74,.08); }

  /* Chart containers */
  .chart-container{ max-width:1800px; margin:0 auto }
  #sizeSection   .chart-container{ max-width:400px; height:400px }
  #metierSection .chart-container{ max-width:1000px; height:900px }
  #skillsSection .chart-container{ max-width:1000px; height:600px }
  #mapOffersSection .map-container{ width:100%; max-width:1100px; height:720px; margin: 0 auto; }

  /* Toggles */
  .chart-controls{ display:flex; justify-content:center; align-items:center; gap:12px; margin:10px 0 }
  .toggle-btn{ position:relative; display:inline-block; width:84px; height:32px; border:none; border-radius:999px; background:var(--ink-400); cursor:pointer; transition: background .2s; }
  .toggle-btn .slider{ position:absolute; top:4px; left:4px; width:24px; height:24px; border-radius:50%; background:#fff; transition:left .25s; }
  .toggle-btn.active{ background: var(--brand-500) }
  .toggle-btn.active .slider{ left:56px }
  .toggle-label{ margin-left:6px; font-size:14px; font-weight:700; color: var(--ink-600) }

  .tri-toggle .evol-btn{ border:1px solid #dbe3ef; border-right:none; padding:7px 16px; background:#f3f6fb; color:var(--brand-700); font-weight:700; cursor:pointer; }
  .tri-toggle .evol-btn:last-child{ border-right:1px solid #dbe3ef }
  .tri-toggle .evol-btn.active{ background:var(--brand-500); color:#fff; border-color:transparent }

  /* Map legend axis text color */
  #mapLegend .tick text{ fill: var(--ink-600); font-size:12px }

  /* Loading skeleton */
  .chart-skel{ height:260px; border-radius:var(--radius); background:linear-gradient(90deg,#f0f3f8 25%,#e6ebf3 37%,#f0f3f8 63%); background-size:400% 100%; animation:sh 1.2s infinite; }
  @keyframes sh{0%{background-position:100% 50%}100%{background-position:0 50%}}
  </style>
</head>
<body>
<header>
  <div class="header-top">
    <div class="left-block"><img src="logo.png" alt="AI-tracker logo" class="logo" /></div>
    <div class="center-block"><h1>The French AI‑tracker</h1></div>
    <div class="right-block"></div>
  </div>
  <nav aria-label="Primary">
    <button type="button" data-target="accueil" aria-current="page">Accueil</button>
    <button type="button" data-target="dashboards">Dashboards</button>
    <button type="button" data-target="projects">About</button>
  </nav>
</header>

<!-- ======= HOME (Accueil) ======= -->
<main id="accueil" class="page active">
  <h2 class="welcome-title">
    Welcome to our AI‑tracker!
    <span class="subtitle">A real‑time dashboard tracking how artificial intelligence spreads through the French economy.</span>
  </h2>
  <div class="explanation">
    <p>The French AI‑tracker is an open‑access <strong>research project</strong> that monitors, almost in real time, the diffusion of AI within French companies.</p>
    <p>Using machine‑learning models to sift through millions of job ads in the
      <a href="https://dares.travail-emploi.gouv.fr/enquete-source/job-offers-collection-and-analysis-system" target="_blank" rel="noopener noreferrer">JOCAS</a> database (DARES), we detect AI‑related roles and thus gradual AI adoption. Weekly updates provide a transparent window onto <em>where</em>, <em>how fast</em> and in <em>which form</em> AI reshapes the labour market.</p>
  </div>

  <h3 class="figures-title">Key figures at a glance</h3>
  <section class="additional-figures">
    <div class="figures-row">
      <button class="key-figure-card clickable" data-scroll="totalOffersSection">
        <h4>Total AI Offers</h4>
        <p id="aiOffersValue">…</p>
        <p><small id="aiOffersLastQuarter">…</small></p>
      </button>
      <button class="key-figure-card clickable" data-scroll="sectorsSection">
        <h4>Total AI Adopters</h4>
        <p id="aiFirmsValue">…</p>
        <p><small id="aiFirmsLastQuarter">…</small></p>
      </button>
    </div>
    <div class="figures-row">
      <button class="key-figure-card clickable" data-scroll="totalOffersSection">
        <h4>Total GenAI Offers</h4>
        <p id="genAiOffersValue">…</p>
        <p><small id="genAiOffersLastQuarter">…</small></p>
      </button>
      <button class="key-figure-card clickable" data-scroll="sectorsSection">
        <h4>Total GenAI Adopters</h4>
        <p id="genAiFirmsValue">…</p>
        <p><small id="genAiFirmsLastQuarter">…</small></p>
      </button>
    </div>
  </section>
</main>

<!-- ==========  DASHBOARDS  ========== -->
<section id="dashboards" class="page" hidden>
  <h2>Dashboards</h2>
  <p class="dashboard-intro">Statistics and visualisations from the JOCAS database using ML methods to detect and classify AI‑related vacancies.</p>

  <div class="sub-nav">
    <button type="button" data-scroll="totalOffersSection">Total Offers</button>
    <button type="button" data-scroll="sectorsSection">Sectors</button>
    <button type="button" data-scroll="sizeSection">Firm‑size</button>
    <button type="button" data-scroll="metierSection">Métiers</button>
    <button type="button" data-scroll="skillsSection">Skills</button>
    <button type="button" data-scroll="mapOffersSection">Map</button>
  </div>

  <!-- TOTAL OFFERS -->
  <div id="totalOffersSection" class="chart-section">
    <h3>Evolution of AI‑Related Job Offers</h3>
    <div class="chart-controls">
      <button type="button" id="btnOfferMode" class="toggle-btn" data-on="Share" data-off="Total" aria-pressed="false"><span class="slider"></span></button>
      <span class="toggle-label" id="lblOfferMode">Total</span>
    </div>
    <div class="chart-container">
      <div class="chart-skel" id="offersSkel" aria-hidden="true"></div>
      <canvas id="offersChart" aria-label="Offers chart" role="img"></canvas>
    </div>
  </div>

  <!-- SECTORS -->
  <div id="sectorsSection" class="chart-section">
    <h3>Firms Adopting AI by Sector</h3>
    <div class="chart-controls">
      <button type="button" id="btnSectorMode" class="toggle-btn" data-on="Share" data-off="Total" aria-pressed="false"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSectorMode">Total</span>
      <button type="button" id="btnSectorCat" class="toggle-btn" data-on="Non gen. AI" data-off="Gen. AI" aria-pressed="false"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSectorCat">Gen AI</span>
    </div>
    <div class="chart-container"><canvas id="sectorsChart"></canvas></div>

    <h3 style="margin-top:60px;">Sector Share in Published Offers</h3>
    <div class="chart-controls tri-toggle">
      <button type="button" class="evol-btn active" id="btnAI"  data-evol="ai">AI</button>
      <button type="button" class="evol-btn"        id="btnGen" data-evol="gen">GenAI</button>
      <button type="button" class="evol-btn"        id="btnAll" data-evol="all">All</button>
    </div>
    <div class="chart-container"><canvas id="sectorEvolChart"></canvas></div>
  </div>

  <!-- SIZE -->
  <div id="sizeSection" class="chart-section">
    <h3>Distribution of AI Adopters by Firm Size</h3>
    <div class="chart-controls">
      <button type="button" id="btnSizeCat" class="toggle-btn" data-on="Gen. AI" data-off="AI" aria-pressed="false"><span class="slider"></span></button>
      <span class="toggle-label" id="lblSizeCat">AI</span>
    </div>
    <div class="chart-container"><canvas id="sizeChart"></canvas></div>
  </div>

  <!-- MÉTIERS -->
  <div id="metierSection" class="chart-section">
    <h3>AI Offers by Métiers (ROME)</h3>
    <div class="chart-controls">
      <button type="button" id="btnMetierCat" class="toggle-btn" data-on="Data/IA" data-off="IA" aria-pressed="false"><span class="slider"></span></button>
      <span class="toggle-label" id="lblMetierCat">IA</span>
    </div>
    <div class="chart-container" style="position:relative">
      <canvas id="metierChart"></canvas>
    </div>
  </div>

  <!-- SKILLS -->
  <div id="skillsSection" class="chart-section">
    <h3>Evolution of Skills in AI Job Ads</h3>
    <div class="chart-controls tri-toggle">
      <button type="button" class="evol-btn active" id="btnSkillsLibraries" data-kind="ml_library">ML Libraries</button>
      <button type="button" class="evol-btn"        id="btnSkillsMethods"  data-kind="method_skills">Methods</button>
      <button type="button" class="evol-btn"        id="btnSkillsBroad"    data-kind="broad_skills">Broad skills</button>
    </div>
    <div class="chart-container"><canvas id="skillsChart"></canvas></div>
  </div>

  <!-- MAP -->
  <div id="mapOffersSection" class="chart-section">
    <h3>Map of French Zones d’Emplois</h3>
    <div class="chart-controls" style="gap:18px; flex-wrap:wrap;">
      <div>
        <button type="button" id="btnMapMode" class="toggle-btn" data-on="Share" data-off="Total" aria-pressed="false"><span class="slider"></span></button>
        <span class="toggle-label" id="lblMapMode">Total</span>
      </div>
      <div>
        <button type="button" id="btnMapCat" class="toggle-btn" data-on="Gen AI" data-off="AI" aria-pressed="false"><span class="slider"></span></button>
        <span class="toggle-label" id="lblMapCat">AI</span>
      </div>
      <label style="display:flex; align-items:center; gap:8px; font-weight:600; color:var(--ink-600)"><input type="checkbox" id="lockScale" /> Lock color scale</label>
    </div>
    <div class="map-container" id="mapOffers"></div>
    <div id="mapLegend" style="max-width:1100px;margin:8px auto 0;"></div>
  </div>
</section>

<!-- ==========  PROJECTS  ========== -->
<section id="projects" class="page" hidden>
  <h2>Projects</h2>
  <section class="authors">
    <h3>Authors</h3>
    <p>The AI‑tracker is the work of :</p>
    <ul>
      <li><strong><a href="https://www.linkedin.com/in/paul-delbouve-180b19268/" target="_blank" rel="noopener noreferrer">Paul Delbouve</a></strong> — Collège de France, PSE, DGE (Ministère de l’Économie et des Finances)</li>
    </ul>
    <p>With the strong support of :</p>
    <ul>
      <li><strong><a href="https://sites.google.com/site/abergeaudeco" target="_blank" rel="noopener noreferrer">Antonin Bergeaud</a></strong> — HEC Paris, LSE, CEPR</li>
      <li><strong><a href="https://www.insead.edu/faculty/philippe-aghion" target="_blank" rel="noopener noreferrer">Philippe Aghion</a></strong> — Collège de France, INSEAD, LSE, CEPR</li>
      <li><strong><a href="https://sites.google.com/view/simon-bunel/home" target="_blank" rel="noopener noreferrer">Simon Bunel</a></strong> — Collège de France, Banque de France</li>
    </ul>
  </section>
  <section class="papers">
    <h3>Academic Papers</h3>
    <p><strong>Diffusion de l'Intelligence Artificielle en France</strong> Aghion, P., Bergeaud, A., Bunel, S., & Delbouve, P. (2025) <em>Economie et Statistique/Economics and Statistics</em> (forthcoming)</p>
  </section>
</section>

<!-- =========================
     APP SCRIPT (ES Module)
     ========================= -->
<script type="module">
// Everything lives inside this module scope — no globals.

/* ----------------------------------
 * ChartTheme wrapper
 * ---------------------------------- */
const ChartTheme = {
  apply(){
    if (!window.Chart) return;
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
    Chart.defaults.color = '#334155';
    Chart.defaults.elements.line.borderWidth = 2;
    Chart.defaults.elements.point.radius = 0;
    Chart.defaults.plugins.legend.labels.boxWidth = 14;
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15,23,42,.92)';
    Chart.defaults.plugins.tooltip.titleColor = '#fff';
    Chart.defaults.plugins.tooltip.bodyColor = '#fff';
  }
};
ChartTheme.apply();

/* ----------------------------------
 * Utilities & helpers
 * ---------------------------------- */
const $  = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const fmt = {
  int:  new Intl.NumberFormat('fr-FR'),
  pct1: new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 1, minimumFractionDigits: 1 })
};

const controllers = new Set();
function fetchWithAbort(url){
  const c = new AbortController(); controllers.add(c);
  return fetch(url, { signal: c.signal }).finally(()=>controllers.delete(c));
}
function cancelAllFetches(){ controllers.forEach(c=>c.abort()); controllers.clear(); }

const fetchCsv = (url) => fetchWithAbort(url).then(r=>{ if(!r.ok){ throw new Error('Missing file: '+url); } return r.text(); });
const parseCsv = (txt, {header=false}={}) => Papa.parse(txt, { header, skipEmptyLines:true }).data;

const monthLabel  = i => `${2019+Math.floor(i/12)}-${String((i%12)+1).padStart(2,'0')}`;
const quarterLabel= i => `Q${(i%4)+1} ${2019+Math.floor(i/4)}`;
const pastel      = i => `hsl(${(i*40)%360},45%,72%)`;

const toNum = v => {
  if (v == null) return NaN;
  const n = Number(String(v).replace(/[%\s\u00A0]/g,'').replace(',', '.'));
  return Number.isFinite(n) ? n : NaN;
};

function toggleButtonState(btn, onLabel, offLabel, isOn){
  btn.classList.toggle('active', isOn);
  btn.setAttribute('aria-pressed', String(isOn));
  const lbl = btn.nextElementSibling;
  if(lbl && lbl.classList.contains('toggle-label')) lbl.textContent = isOn ? onLabel : offLabel;
}

function hideSkel(id){ const el = document.getElementById(id); if(el) el.remove(); }

/* ----------------------------------
 * Navigation & page switching (no inline handlers)
 * ---------------------------------- */
function showPage(id){
  cancelAllFetches();
  $$('.page').forEach(p=>{ p.classList.remove('active'); p.setAttribute('hidden',''); });
  const next = document.getElementById(id);
  next.classList.add('active'); next.removeAttribute('hidden');
  window.scrollTo({ top: 0, behavior: 'auto' });
  if(id==='dashboards' && typeof updateLegend==='function') setTimeout(updateLegend, 50);
}

function wireNav(){
  $$('nav[aria-label="Primary"] button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('nav[aria-label="Primary"] button').forEach(b=>b.removeAttribute('aria-current'));
      btn.setAttribute('aria-current','page');
      showPage(btn.dataset.target);
    });
  });
  $$('[data-scroll]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id = el.dataset.scroll; if(!id) return;
      showPage('dashboards');
      document.getElementById(id)?.scrollIntoView({ behavior:'smooth' });
    })
  });
}

/* ----------------------------------
 * Data holders
 * ---------------------------------- */
let dateLabels=[],totalGen=[],totalAI=[],totalCV=[],totalNLP=[],shareGen=[],shareAI=[],shareCV=[],shareNLP=[];
let qLabels=[],indTotGen=[],servTotGen=[],indTotNon=[],servTotNon=[],indShGen=[],servShGen=[],indShNon=[],servShNon=[];
let sizeLabels=[],sizeAi=[],sizeGen=[];
let evolDates=[],evolDatesGen=[],evolAI=[],evolGen=[],evolAll=[];
let metierDates=[],metierDatesData=[],metierIA=[],metierData=[];
const skillsDates={ml_library:[],method_skills:[],broad_skills:[]};
const skillsSets ={ml_library:[],method_skills:[],broad_skills:[]};

/* ----------------------------------
 * Chart builders
 * ---------------------------------- */
const metierPalette=[
  'rgba(31,119,180,1.0)','rgba(174,199,232,1.0)','rgba(255,127,14,1.0)','rgba(255,187,120,1.0)',
  'rgba(44,160,44,1.0)','rgba(152,223,138,1.0)','rgba(214, 39, 40,1.0)','rgba(255,152,150,1.0)',
  'rgba(148,103,189,1.0)','rgba(196,172,228,1.0)','rgba(140, 86, 75,1.0)','rgba(196,156,148,1.0)',
  'rgba(227,119,194,1.0)','rgba(247,182,210,1.0)','rgba(127,127,127,1.0)','rgba(199,199,199,1.0)',
  'rgba(188,189, 34,1.0)','rgba(219,219,141,1.0)','rgba( 23,190,207,1.0)','rgba(158,218,229,1.0)'
];

let offersChart, offersMode='total';
function buildOffers(){
  offersChart = new Chart(document.getElementById('offersChart'),{
    type:'bar',
    data:{ labels: dateLabels, datasets:[
      {label:'Generative AI',   data: totalGen, backgroundColor:'rgba(255,99,132,0.7)'},
      {label:'General AI',      data: totalAI,  backgroundColor:'rgba(75,192,192,0.7)'},
      {label:'Computer Vision', data: totalCV,  backgroundColor:'rgba(54,162,235,0.7)'},
      {label:'NLP',             data: totalNLP, backgroundColor:'rgba(153,102,255,0.7)'}
    ]},
    options:{ responsive:true, scales:{ x:{ stacked:true }, y:{ stacked:true } } }
  });
  hideSkel('offersSkel');
}
function toggleTotalShare(){
  offersMode = (offersMode==='total') ? 'share' : 'total';
  const on = (offersMode==='share');
  toggleButtonState($('#btnOfferMode'), 'Share', 'Total', on);
  $('#lblOfferMode').textContent = on ? 'Share' : 'Total';
  offersChart.data.datasets[0].data = on ? shareGen : totalGen;
  offersChart.data.datasets[1].data = on ? shareAI  : totalAI;
  offersChart.data.datasets[2].data = on ? shareCV  : totalCV;
  offersChart.data.datasets[3].data = on ? shareNLP : totalNLP;
  offersChart.update();
}

let sectorsChart, secMode='total', secCat='gen';
function buildSectors(){
  sectorsChart = new Chart(document.getElementById('sectorsChart'),{
    type:'bar',
    data:{ labels:qLabels, datasets:[
      { label:'Industrie', backgroundColor:'rgba(153,102,255,0.7)', data:[] },
      { label:'Services',  backgroundColor:'rgba(255,205,86,0.7)',  data:[] }
    ]},
    options:{ responsive:true }
  });
  refreshSectors();
}
function refreshSectors(){
  let ind, serv;
  if(secMode==='total' && secCat==='gen'){ ind=indTotGen; serv=servTotGen; }
  else if(secMode==='total'){ ind=indTotNon; serv=servTotNon; }
  else if(secCat==='gen'){ ind=indShGen; serv=servShGen; }
  else { ind=indShNon; serv=servShNon; }
  sectorsChart.data.datasets[0].data = ind;
  sectorsChart.data.datasets[1].data = serv;
  sectorsChart.update();
}
function toggleSectorsTotalShare(){
  secMode = (secMode==='total') ? 'share' : 'total';
  toggleButtonState($('#btnSectorMode'), 'Share', 'Total', secMode==='share');
  $('#lblSectorMode').textContent = (secMode==='share') ? 'Share' : 'Total';
  refreshSectors();
}
function toggleSectorsGenNonGen(){
  secCat = (secCat==='gen') ? 'nongen' : 'gen';
  const isGen = (secCat==='gen');
  toggleButtonState($('#btnSectorCat'), 'Non gen. AI', 'Gen. AI', !isGen);
  $('#lblSectorCat').textContent = isGen ? 'Gen AI' : 'Non generative AI';
  refreshSectors();
}

let evolChart, evolType='ai';
function buildEvol(){
  evolChart = new Chart(document.getElementById('sectorEvolChart'),{
    type:'line',
    data:{ labels: evolDates, datasets: evolAI },
    options:{ responsive:true, scales:{ y:{ stacked:true } }, elements:{ line:{ fill:true, tension:.3 } } }
  });
}
function setEvolType(t){
  evolType = t;
  $('#btnAI') .classList.toggle('active', t==='ai');
  $('#btnGen').classList.toggle('active', t==='gen');
  $('#btnAll').classList.toggle('active', t==='all');
  if(t==='ai'){ evolChart.data.labels=evolDates;    evolChart.data.datasets=evolAI; }
  else if(t==='gen'){ evolChart.data.labels=evolDatesGen; evolChart.data.datasets=evolGen; }
  else { evolChart.data.labels=evolDates; evolChart.data.datasets=evolAll; }
  evolChart.update();
}

let sizeChart, sizeCat='ai';
function buildSize(){
  sizeChart = new Chart(document.getElementById('sizeChart'),{
    type:'pie',
    data:{ labels:sizeLabels, datasets:[{ data:sizeAi }] },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });
}
function toggleSizeAiGen(){
  sizeCat = (sizeCat==='ai') ? 'gen' : 'ai';
  const isGen = (sizeCat==='gen');
  toggleButtonState($('#btnSizeCat'), 'Gen. AI', 'AI', isGen);
  $('#lblSizeCat').textContent = isGen ? 'Generative AI' : 'AI';
  sizeChart.data.datasets[0].data = isGen ? sizeGen : sizeAi;
  sizeChart.update();
}

/* ------------- Map (D3) ------------- */
let mapMode='total', mapCat='ai';
let mapData = new Map(); let zonesFC; let svg, gFill, path, colorScale, zonePaths; let shareScaleFactor=1; let lockedDomain=null;
let legendSvg, legendScale, legendAxis, legendGradient;

function currentMetric(v){ return (mapCat==='ai') ? (mapMode==='total' ? v.ia  : v.ia_rel) : (mapMode==='total' ? v.gen : v.gen_rel); }
function paletteForMode(){ return (mapCat==='ai') ? d3.interpolateReds : d3.interpolateBlues; }

function updateColorScale(){
  const raw = zonesFC.features.map(f=>{ const v = mapData.get(f.properties.zone); return v ? currentMetric(v) : NaN; }).filter(Number.isFinite);
  const isShare = (mapMode==='share');
  const maxAbs = d3.max(raw.map(Math.abs)) || 0;
  shareScaleFactor = (isShare && maxAbs <= 1) ? 100 : 1;
  const vals = raw.map(x => x*shareScaleFactor);
  let min = d3.min(vals), max = d3.max(vals);
  if($('#lockScale')?.checked){
    if(!lockedDomain) lockedDomain=[min,max];
    [min,max] = lockedDomain;
  } else { lockedDomain=null; }
  if (!(isFinite(min) && isFinite(max)) || min===max){ const eps = (min===0)?1:Math.abs(min)*0.01; min = (min||0)-eps/2; max = (max||1)+eps/2; }
  colorScale = d3.scaleSequential(paletteForMode()).domain([min, max]).clamp(true);
}

function formatMetricValue(x){
  if (!Number.isFinite(x)) return 'n/a';
  const isShare=(mapMode==='share');
  if(isShare){ if(shareScaleFactor===100) return fmt.pct1.format(x*100/100); return fmt.pct1.format(x); }
  return fmt.int.format(x);
}

function initLegend(){
  const wrap = document.getElementById('mapLegend'); wrap.innerHTML='';
  const W = Math.min(wrap.clientWidth || 600, 1100), H = 48, PAD = {l:14, r:14, t:8, b:20};
  legendSvg = d3.select(wrap).append('svg').attr('width',W).attr('height',H);
  const defs = legendSvg.append('defs');
  legendGradient = defs.append('linearGradient').attr('id','legendGradient').attr('x1','0%').attr('x2','100%').attr('y1','0%').attr('y2','0%');
  legendSvg.append('rect').attr('x',PAD.l).attr('y',PAD.t).attr('height',12).attr('rx',2).attr('width',W-PAD.l-PAD.r).attr('fill','url(#legendGradient)');
  legendScale = d3.scaleLinear().range([PAD.l, W-PAD.r]);
  legendAxis  = d3.axisBottom(legendScale).ticks(6).tickFormat(x=>{
    const isShare = (mapMode==='share');
    if(isShare && shareScaleFactor===100) return d3.format('.1f')(x)+'%';
    if(isShare) return d3.format('.3f')(x);
    if(x>=1000) return d3.format('~s')(x);
    return d3.format(',')(x);
  });
  legendSvg.append('g').attr('class','legendAxis').attr('transform',`translate(0, ${PAD.t+12})`).call(legendAxis);
}

function updateLegend(){
  if(!legendSvg) initLegend();
  const [d0,d1] = colorScale.domain();
  legendScale.domain([d0,d1]);
  legendSvg.select('.legendAxis').call( d3.axisBottom(legendScale).ticks(6).tickFormat(x=>{
    const isShare = (mapMode==='share');
    if(isShare && shareScaleFactor===100) return d3.format('.1f')(x)+'%';
    if(isShare) return d3.format('.3f')(x);
    if(x>=1000) return d3.format('~s')(x);
    return d3.format(',')(x);
  }));
  const interp = paletteForMode();
  const stops = d3.range(0,1.0001,0.1);
  legendGradient.selectAll('stop').remove();
  legendGradient.selectAll('stop').data(stops).enter().append('stop')
    .attr('offset', d=> (d*100)+'%')
    .attr('stop-color', d=> interp(d));
}

let tip; // singleton tooltip
function initFranceStatic(){
  const container = document.getElementById('mapOffers');
  container.innerHTML='';
  const W=1000, H=880;
  const svgSel = d3.select(container).append('svg')
    .attr('viewBox',`0 0 ${W} ${H}`).attr('preserveAspectRatio','xMidYMid meet')
    .style('width','100%').style('height','100%');
  svg = svgSel.node();

  const projection = d3.geoConicConformal().parallels([44,49]).rotate([-3,0]);
  projection.fitSize([W,H], zonesFC);
  path = d3.geoPath(projection);

  updateColorScale();

  tip = document.getElementById('mapTip') || Object.assign(document.createElement('div'),{ id:'mapTip' });
  Object.assign(tip.style,{ position:'absolute', pointerEvents:'none', background:'#fff', border:'1px solid #ccc', borderRadius:'4px', padding:'6px 8px', boxShadow:'0 2px 6px rgba(0,0,0,.15)', font:'12px sans-serif', opacity:0 });
  if(!tip.parentNode) document.body.appendChild(tip);

  gFill = d3.select(svg).append('g');
  zonePaths = gFill.selectAll('path').data(zonesFC.features).enter().append('path')
    .attr('d', path)
    .attr('fill', d => fillValue(d))
    .attr('stroke', '#d0d0d0')
    .attr('stroke-width', 1)
    .on('mouseenter', function(){ d3.select(this).attr('stroke','#111').attr('stroke-width',2); tip.style.opacity=1; })
    .on('mousemove', function(ev, d){
      const zone = d.properties.zone; const v = mapData.get(zone);
      const val = v ? currentMetric(v) : NaN;
      tip.innerHTML = `<b>${zone}</b><br/>` + (mapCat==='ai' ? `AI: <b>${formatMetricValue(v?.ia)}</b>${mapMode==='share'?` (${formatMetricValue(v?.ia_rel)})`:''}` : `GenAI: <b>${formatMetricValue(v?.gen)}</b>${mapMode==='share'?` (${formatMetricValue(v?.gen_rel)})`:''}`);
      tip.style.left = (ev.pageX + 12) + 'px'; tip.style.top = (ev.pageY + 12) + 'px';
    })
    .on('mouseleave', function(){ d3.select(this).attr('stroke','#d0d0d0').attr('stroke-width',1); tip.style.opacity=0; });
}

function fillValue(feature){ const v = mapData.get(feature.properties.zone); if(!v) return '#ccc'; let x = currentMetric(v); if(!Number.isFinite(x)) return '#ccc'; if(mapMode==='share') x *= shareScaleFactor; return colorScale(x); }
function recolorFrancePolygon(){ updateColorScale(); updateLegend(); zonePaths.attr('fill', d=> fillValue(d)); }

async function loadFrancePolygonMap(){
  const topo = await fetchWithAbort('data/france_zones.topo.json').then(r=>r.json());
  const objName = Object.keys(topo.objects)[0];
  zonesFC = topojson.feature(topo, topo.objects[objName]);
  zonesFC.features.forEach(f=>{ if(!f.properties.zone){ f.properties.zone = f.properties['Nom Officiel Zone emploi 2020'] || f.properties.ZE2020 || f.properties.nom || f.properties.code_insee || null; } });
  const csvTxt = await fetchCsv('data/map_offers_values.csv');
  const rows = parseCsv(csvTxt, {header:true});
  rows.forEach(r=>{ if(!r.zone) return; mapData.set(r.zone, { ia:+r.ia, ia_rel:+r.ia_rel, gen:+r.gen, gen_rel:+r.gen_rel, total_offers:+r.total_offers }); });
  initFranceStatic(); updateLegend();
}

function wireMapToggles(){
  $('#btnMapMode').addEventListener('click', ()=>{ mapMode = (mapMode==='total') ? 'share' : 'total'; toggleButtonState($('#btnMapMode'), 'Share', 'Total', mapMode==='share'); $('#lblMapMode').textContent = mapMode==='share' ? 'Share' : 'Total'; recolorFrancePolygon(); });
  $('#btnMapCat').addEventListener('click', ()=>{ mapCat = (mapCat==='ai') ? 'gen' : 'ai'; toggleButtonState($('#btnMapCat'), 'Gen AI', 'AI', mapCat==='gen'); $('#lblMapCat').textContent = (mapCat==='gen') ? 'Generative AI' : 'AI'; recolorFrancePolygon(); });
  $('#lockScale')?.addEventListener('change', ()=> recolorFrancePolygon());
  window.addEventListener('resize', ()=>{ if(colorScale) updateLegend(); });
}

/* ----------------------------------
 * Robust loaders (CSV)
 * ---------------------------------- */
async function loadHome(){
  try{
    const rows = parseCsv(await fetchCsv('data/general_results.csv')); // header=false
    const d    = rows.reduce((h,r)=>(h[r[0]]=+r[1]||0, h),{});
    $('#aiOffersValue').textContent        = d['Total IA offers'] ?? '0';
    $('#aiOffersLastQuarter').textContent  = `+${d['Number of AI offers in last quarter'] ?? 0} offers last quarter`;
    $('#aiFirmsValue').textContent         = d['Number of firms with AI offers'] ?? '0';
    $('#aiFirmsLastQuarter').textContent   = `+${d['Number of new AI adopters in last quarter'] ?? 0} new firms last quarter`;
    $('#genAiOffersValue').textContent     = d['Total IA générative offers'] ?? '0';
    $('#genAiOffersLastQuarter').textContent=`+${d['Number of GenAI offers in last quarter'] ?? 0} offers last quarter`;
    $('#genAiFirmsValue').textContent      = d['Number of firms with GenAI offers'] ?? '0';
    $('#genAiFirmsLastQuarter').textContent=`+${d['Number of new GenAI adopters in last quarter'] ?? 0} new firms last quarter`;
  }catch(e){ console.error('Error loading home figures:', e); }
}

async function loadTwoSectors(file, fillLabels, indArr, servArr){
  const parsed = Papa.parse(await fetchCsv(file), { header:true, skipEmptyLines:true, dynamicTyping:true }).data;
  if (fillLabels) qLabels = parsed.map(r=>r.date);
  parsed.forEach(r=>{ indArr.push(toNum(r.Industrie)); servArr.push(toNum(r.Services)); });
}

async function loadEvol(file, targetArr, dateArr){
  const d = Papa.parse(await fetchCsv(file), { header:true, skipEmptyLines:true }).data;
  if(!d.length) return;
  if(dateArr.length===0) d.forEach(x=>dateArr.push(x.date));
  Object.keys(d[0]).filter(k=>k!=='date').forEach((k,i)=>{
    targetArr.push({ label:k, data:d.map(x=>+x[k]), borderColor:pastel(i), backgroundColor:pastel(i), fill:true, stack:'s' });
  });
}

async function loadMetier(file, targetArr, dateArr){
  const txt = await fetchCsv(file);
  const d   = Papa.parse(txt, { header:true, skipEmptyLines:true }).data;
  if(!d.length) return;
  if(dateArr.length===0) d.forEach(x=>dateArr.push(x.date));
  const keys = Object.keys(d[0]).filter(k=>k!=='date');
  keys.forEach((k,i)=>{
    const fill = metierPalette[i % metierPalette.length];
    const bg   = fill.replace(/1\.0\)$/, '0.35)');
    targetArr.push({ label:k, data:d.map(x=>toNum(x[k])), borderColor:fill, backgroundColor:bg, fill:true, stack:'s', pointRadius:0 });
  });
}

async function loadSkills(file, key){
  const d = Papa.parse(await fetchCsv(file), { header:true, skipEmptyLines:true }).data;
  if(!d.length) return;
  skillsDates[key] = d.map(x=>x.date);
  const keys = Object.keys(d[0]).filter(k=>k!=='date');
  skillsSets[key] = keys.map((k,i)=>({ label:k, data:d.map(x=>+x[k]), borderColor:pastel(i), pointRadius:0, fill:false }));
}

/* ----------------------------------
 * Wire UI events
 * ---------------------------------- */
function wireUI(){
  // Offers toggle
  $('#btnOfferMode').addEventListener('click', toggleTotalShare);
  // Sector toggles
  $('#btnSectorMode').addEventListener('click', toggleSectorsTotalShare);
  $('#btnSectorCat').addEventListener('click', toggleSectorsGenNonGen);
  // Sector evolution tabs
  $$('.chart-controls .evol-btn').forEach(btn=>{
    if(btn.dataset.evol){ btn.addEventListener('click', ()=> setEvolType(btn.dataset.evol)); }
    if(btn.dataset.kind){ btn.addEventListener('click', ()=> setSkillsType(btn.dataset.kind)); }
  });
  // Size toggle
  $('#btnSizeCat').addEventListener('click', toggleSizeAiGen);
  // Metier toggle
  $('#btnMetierCat').addEventListener('click', ()=>{
    metierMode = (metierMode==='ia') ? 'data' : 'ia';
    toggleButtonState($('#btnMetierCat'), 'Data/IA', 'IA', metierMode==='data');
    $('#lblMetierCat').textContent = (metierMode==='data') ? 'Data/IA' : 'IA';
    metierChart.data.labels   = (metierMode==='ia') ? metierDates    : metierDatesData;
    metierChart.data.datasets = (metierMode==='ia') ? metierIA       : metierData;
    metierChart.update();
  });

  // Skills tabs
  $('#btnSkillsLibraries').addEventListener('click', ()=> setSkillsType('ml_library'));
  $('#btnSkillsMethods').addEventListener('click',  ()=> setSkillsType('method_skills'));
  $('#btnSkillsBroad').addEventListener('click',    ()=> setSkillsType('broad_skills'));
}

/* ----------------------------------
 * Skills chart
 * ---------------------------------- */
let skillsChart, skillsType='ml_library';
function buildSkills(){
  skillsChart = new Chart(document.getElementById('skillsChart'),{
    type:'line',
    data:{ labels: skillsDates[skillsType], datasets: skillsSets[skillsType] },
    options:{ responsive:true, maintainAspectRatio:false, interaction:{ mode:'nearest', intersect:false }, scales:{ y:{ stacked:false } }, elements:{ line:{ fill:false, tension:.25 } }, plugins:{ legend:{ position:'bottom' } } }
  });
}
function setSkillsType(t){
  skillsType = t;
  $('#btnSkillsLibraries').classList.toggle('active', t==='ml_library');
  $('#btnSkillsMethods') .classList.toggle('active', t==='method_skills');
  $('#btnSkillsBroad')   .classList.toggle('active', t==='broad_skills');
  skillsChart.data.labels   = skillsDates[t];
  skillsChart.data.datasets = skillsSets[t];
  skillsChart.update();
}

/* ----------------------------------
 * Métiers chart
 * ---------------------------------- */
let metierChart, metierMode='ia';
function buildMetier(){
  metierChart = new Chart(document.getElementById('metierChart'),{
    type:'line', data:{ labels:metierDates, datasets:metierIA },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ stacked:true } }, elements:{ line:{ fill:true, tension:.3 } } }
  });
}

/* ----------------------------------
 * Bootstrapping
 * ---------------------------------- */
async function boot(){
  wireNav();
  wireUI();
  wireMapToggles();
  await loadHome();

  try{
    // offers
    parseCsv(await fetchCsv('data/offers_total.csv')).forEach(r=>{ dateLabels.push(monthLabel(+r[0])); totalGen.push(+r[1]); totalAI.push(+r[2]); totalCV.push(+r[3]); totalNLP.push(+r[4]); });
    parseCsv(await fetchCsv('data/offers_share.csv')).forEach(r=>{ shareGen.push(+r[1]); shareAI.push(+r[2]); shareCV.push(+r[3]); shareNLP.push(+r[4]); });
    buildOffers();

    // sectors
    await loadTwoSectors('data/two_sectors_total_gen.csv',    true,  indTotGen, servTotGen);
    await loadTwoSectors('data/two_sectors_total_nongen.csv', false, indTotNon, servTotNon);
    await loadTwoSectors('data/two_sectors_share_gen.csv',    false, indShGen,  servShGen);
    await loadTwoSectors('data/two_sectors_share_nongen.csv', false, indShNon,  servShNon);
    buildSectors();

    // sector evolution
    await loadEvol('data/sector_evol_ia.csv'   ,evolAI ,evolDates);
    await loadEvol('data/sector_evol_iagen.csv',evolGen,evolDatesGen);
    await loadEvol('data/sector_evol_all.csv'  ,evolAll,evolDates);
    buildEvol();

    // size
    parseCsv(await fetchCsv('data/distrib_size.csv')).forEach(r=>{ sizeLabels.push(r[0]); sizeAi.push(+r[1]); sizeGen.push(+r[2]); });
    buildSize();

    // métiers
    await loadMetier('data/metier_area_ia.csv'  ,metierIA  ,metierDates);
    await loadMetier('data/metier_area_data.csv',metierData,metierDatesData);
    buildMetier();

    // skills
    await loadSkills('data/evolution_ml_library_skills.csv','ml_library');
    await loadSkills('data/evolution_method_skills.csv','method_skills');
    await loadSkills('data/evolution_broad_skills.csv','broad_skills');
    buildSkills();

    // map
    try { await loadFrancePolygonMap(); } 
    catch (e) { console.error('Map failed:', e); const m = document.getElementById('mapOffers'); if (m) m.innerHTML = '<div style="text-align:center;padding:20px;color:#a00">Map data missing or invalid.</div>'; }

  } catch(err){ console.error('Error during dashboard load:', err); }
}

// Wait until external libs are ready (defer) and DOM is parsed
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot); else boot();

</script>
</body>
</html>
